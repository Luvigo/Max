@startuml
title Módulo 1: Diagrama de Clases - Auth + Roles

package "Django Auth" {
    class User {
        +id: int
        +username: str
        +password: str
        +email: str
        +is_superuser: bool
        +is_staff: bool
        +is_active: bool
        +authenticate()
        +login()
        +logout()
    }
}

package "Modelos Multi-tenant" {
    class Institution {
        +id: UUID
        +name: str
        +slug: str
        +code: str
        +status: str
        +agent_token: str
    }
    
    class Membership {
        +id: UUID
        +user: FK(User)
        +institution: FK(Institution)
        +role: str ['admin', 'institution', 'tutor', 'student']
        +is_active: bool
        --
        +is_admin(): bool
        +is_institution_admin(): bool
        +is_tutor_or_above(): bool
        +is_student(): bool
    }
    
    class UserRoleHelper <<utility>> {
        {static} +get_user_role(user): str
        {static} +get_user_institutions(user): QuerySet
        {static} +get_single_institution(user): Institution
        {static} +user_has_role(user, roles, institution): bool
    }
}

package "Decorators" {
    class "@login_required" <<decorator>> {
        Requiere usuario autenticado
    }
    
    class "@role_required(*roles)" <<decorator>> {
        Requiere uno de los roles especificados
    }
    
    class "@admin_required" <<decorator>> {
        Solo superuser/staff
        Redirige a /admin/
    }
    
    class "@tutor_required" <<decorator>> {
        Roles: admin, institution, tutor
    }
    
    class "@student_required" <<decorator>> {
        Cualquier usuario con membresía
    }
    
    class "@institution_required" <<decorator>> {
        Requiere institución en contexto URL
    }
}

package "Middleware" {
    class TenantMiddleware {
        +current_institution: Institution
        +current_membership: Membership
        +user_role: str
        +user_institutions: QuerySet
        --
        +__call__(request)
    }
}

User "1" -- "*" Membership
Institution "1" -- "*" Membership
TenantMiddleware ..> Institution
TenantMiddleware ..> Membership
UserRoleHelper ..> Membership
UserRoleHelper ..> User

note bottom of Membership
  **Roles disponibles:**
  - admin: Administrador Global
  - institution: Admin de Institución
  - tutor: Tutor/Docente
  - student: Estudiante
end note

note bottom of "@admin_required"
  El Admin NO tiene dashboard custom.
  Usa exclusivamente /admin/
end note
@enduml
