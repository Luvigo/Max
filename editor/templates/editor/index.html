{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAX-IDE | Arduino Block Editor</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Blockly -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="{% static 'editor/css/style.css' %}">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div class="logo-text">MAX-IDE</div>
                <span class="logo-badge">ARDUINO</span>
            </div>
            
            <div class="header-controls">
                <!-- Board Selector -->
                <div class="control-group">
                    <label>
                        <span>üéØ</span>
                        Board
                    </label>
                    <select id="boardSelect">
                        <option value="arduino:avr:uno">Arduino UNO</option>
                        <option value="arduino:avr:nano">Arduino Nano</option>
                        <option value="arduino:avr:mega">Arduino Mega</option>
                        <option value="arduino:avr:leonardo">Arduino Leonardo</option>
                    </select>
                </div>
                
                <!-- Port Selector -->
                <div class="control-group">
                    <label>
                        <span>üîå</span>
                        Puerto
                    </label>
                    <select id="portSelect">
                        <option value="">Seleccionar...</option>
                    </select>
                    <button class="btn btn-icon-only btn-ghost" id="btnAddPort" title="Agregar nuevo puerto">
                        ‚ûï
                    </button>
                    <button class="btn btn-icon-only btn-ghost" id="btnRefreshPorts" title="Actualizar puertos">
                        üîÑ
                    </button>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-ghost" id="btnSerialMonitor" title="Monitor Serial">
                        <span>üìü</span>
                        <span>Serial</span>
                    </button>
                    <button class="btn btn-warning" id="btnCompile">
                        <span>‚öôÔ∏è</span>
                        <span>Verificar</span>
                    </button>
                    <button class="btn btn-success" id="btnUpload">
                        <span>üöÄ</span>
                        <span>Subir</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Workspace de Blockly -->
            <div class="workspace-container">
                <div class="workspace-header">
                    <div class="workspace-tabs">
                        <button class="workspace-tab active">
                            <span>üì¶</span>
                            Bloques
                        </button>
                    </div>
                    <div class="workspace-actions">
                        <button class="btn btn-sm btn-ghost" id="btnNew" title="Nuevo proyecto">
                            üìÑ Nuevo
                        </button>
                        {% if user.is_authenticated %}
                        <button class="btn btn-sm btn-ghost" id="btnSaveProject" title="Guardar Proyecto">
                            üíæ Guardar Proyecto
                        </button>
                        <button class="btn btn-sm btn-ghost" id="btnLoadProject" title="Cargar Proyecto">
                            üìÇ Mis Proyectos
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-ghost" id="btnSave" title="Guardar archivo local">
                            üíæ Guardar Local
                        </button>
                        <button class="btn btn-sm btn-ghost" id="btnLoad" title="Cargar archivo local">
                            üìÇ Cargar Local
                        </button>
                    </div>
                </div>
                
                <div id="blocklyDiv"></div>
            </div>
            
            <!-- Panel de c√≥digo -->
            <div class="code-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <span class="icon">&lt;/&gt;</span>
                        C√≥digo Arduino
                    </h3>
                    <button class="btn btn-sm btn-ghost" id="btnCopyCode" title="Copiar c√≥digo">
                        üìã Copiar
                    </button>
                </div>
                <div class="code-content">
                    <pre><code id="codeOutput">// El c√≥digo aparecer√° aqu√≠
// Arrastra bloques para empezar

void setup() {
  
}

void loop() {
  
}</code></pre>
                </div>
                
                <!-- Console -->
                <div class="console-panel">
                    <div class="console-header">
                        <h4>
                            <span>üìü</span>
                            Consola
                        </h4>
                        <button class="btn btn-sm btn-ghost" id="btnClearConsole">Limpiar</button>
                    </div>
                    <div class="console-content" id="consoleOutput">
                        <div class="console-line info">
                            <span class="console-time">[00:00]</span>
                            <span>MAX-IDE listo. ¬°Arrastra bloques para empezar!</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Agent Install Banner -->
        <div class="agent-banner" id="agentBanner" style="display: none;">
            <div class="agent-banner-content">
                <div class="agent-banner-icon">üîß</div>
                <div class="agent-banner-text">
                    <strong>Agent local requerido para subir c√≥digo</strong>
                    <span>Instala el MAX-IDE Agent en tu PC para poder subir c√≥digo al Arduino</span>
                </div>
                <div class="agent-banner-actions">
                    <button class="btn btn-sm btn-ghost" id="btnCheckAgent">
                        üîÑ Verificar conexi√≥n
                    </button>
                    <button class="btn btn-sm btn-primary" id="btnInstallAgent">
                        üì• Instrucciones de instalaci√≥n
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span class="status-dot disconnected" id="statusDot"></span>
                    <span id="statusText">Sin conexi√≥n</span>
                </div>
                <div class="status-item">
                    <span>üì¶</span>
                    <span id="blockCount">0 bloques</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item" id="agentStatus">
                    <span class="status-dot disconnected" id="agentStatusDot"></span>
                    <span id="agentStatusText">Agent: Verificando...</span>
                </div>
                <div class="status-item" id="boardInfo">
                    <span>üéØ</span>
                    <span>Arduino UNO</span>
                </div>
                <div class="status-item">
                    MAX-IDE v1.0
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Modal Monitor Serial -->
    <div class="modal-overlay" id="serialModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">üìü</span>
                    Monitor Serial
                </h2>
                <button class="modal-close" id="btnCloseSerial">&times;</button>
            </div>
            <div class="modal-body">
                <div class="serial-controls">
                    <div class="control-group">
                        <label>Puerto (Web Serial API)</label>
                        <select id="serialPortSelect" disabled>
                            <option value="">Usa "Conectar" para seleccionar puerto</option>
                        </select>
                        <small style="color: #888; font-size: 11px;">El puerto se selecciona al hacer clic en "Conectar"</small>
                    </div>
                    <div class="control-group">
                        <label>Baudrate</label>
                        <select id="serialBaudrate">
                            <option value="9600">9600</option>
                            <option value="115200">115200</option>
                            <option value="57600">57600</option>
                            <option value="38400">38400</option>
                            <option value="19200">19200</option>
                            <option value="4800">4800</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="btnSerialConnect">
                        <span>üîó</span>
                        Conectar
                    </button>
                    <button class="btn btn-danger hidden" id="btnSerialDisconnect">
                        <span>‚õî</span>
                        Desconectar
                    </button>
                    <div class="connection-status disconnected" id="serialStatus">
                        <span class="status-dot disconnected"></span>
                        <span>Desconectado</span>
                    </div>
                    <div class="flex-1"></div>
                    <button class="btn btn-sm btn-ghost" id="btnClearSerial">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                <div class="serial-output" id="serialOutput">
                    <div class="line system">Esperando conexi√≥n...</div>
                </div>
                <div class="serial-input-container">
                    <input type="text" class="serial-input" id="serialInput" placeholder="Escribe un mensaje y presiona Enter..." disabled>
                    <button class="btn btn-primary" id="btnSerialSend" disabled>
                        Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Modal Instalar Agent -->
    <div class="modal-overlay" id="agentInstallModal" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">üîß</span>
                    Instalar MAX-IDE Agent
                </h2>
                <button class="modal-close" id="btnCloseAgentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="agent-install-intro">
                    <p>El <strong>MAX-IDE Agent</strong> es una peque√±a aplicaci√≥n que se ejecuta en tu computadora para permitir la comunicaci√≥n con tu Arduino.</p>
                    <p>Solo necesitas instalarlo una vez y se iniciar√° autom√°ticamente.</p>
                </div>
                
                <div class="agent-install-tabs">
                    <button class="agent-tab active" data-os="windows">ü™ü Windows</button>
                    <button class="agent-tab" data-os="mac">üçé macOS</button>
                    <button class="agent-tab" data-os="linux">üêß Linux</button>
                </div>
                
                <!-- Windows Instructions -->
                <div class="agent-instructions" id="instructions-windows">
                    <h4>Instalaci√≥n en Windows:</h4>
                    <ol>
                        <li>
                            <strong>Descarga Python</strong> (si no lo tienes):<br>
                            <a href="https://www.python.org/downloads/" target="_blank" class="btn btn-sm btn-ghost" style="margin: 8px 0;">
                                üêç Descargar Python
                            </a>
                            <br><small>Durante la instalaci√≥n, marca "Add Python to PATH"</small>
                        </li>
                        <li>
                            <strong>Descarga el Agent:</strong><br>
                            <a href="/static/agent/maxide-agent.zip" download class="btn btn-sm btn-primary" style="margin: 8px 0;">
                                üì• Descargar MAX-IDE Agent
                            </a>
                        </li>
                        <li>
                            <strong>Descomprime</strong> el archivo en una carpeta (ej: <code>C:\MAX-IDE-Agent</code>)
                        </li>
                        <li>
                            <strong>Ejecuta</strong> el archivo <code>start_agent.bat</code> haciendo doble clic
                        </li>
                        <li>
                            <strong>(Opcional)</strong> Para inicio autom√°tico, ejecuta <code>install.bat</code>
                        </li>
                    </ol>
                    <div class="agent-terminal">
                        <code>
                            # O instala manualmente desde terminal:<br>
                            pip install flask flask-cors pyserial requests<br>
                            python agent.py
                        </code>
                    </div>
                </div>
                
                <!-- macOS Instructions -->
                <div class="agent-instructions" id="instructions-mac" style="display: none;">
                    <h4>Instalaci√≥n en macOS:</h4>
                    <ol>
                        <li>
                            <strong>Abre Terminal</strong> (Cmd + Space, escribe "Terminal")
                        </li>
                        <li>
                            <strong>Descarga el Agent:</strong><br>
                            <a href="/static/agent/maxide-agent.zip" download class="btn btn-sm btn-primary" style="margin: 8px 0;">
                                üì• Descargar MAX-IDE Agent
                            </a>
                        </li>
                        <li>
                            <strong>Descomprime</strong> y navega a la carpeta
                        </li>
                        <li>
                            <strong>Ejecuta</strong> en Terminal:
                        </li>
                    </ol>
                    <div class="agent-terminal">
                        <code>
                            # Instalar dependencias y ejecutar:<br>
                            cd ~/Downloads/maxide-agent<br>
                            pip3 install flask flask-cors pyserial requests<br>
                            python3 agent.py<br><br>
                            # O para instalaci√≥n autom√°tica:<br>
                            python3 install.py
                        </code>
                    </div>
                </div>
                
                <!-- Linux Instructions -->
                <div class="agent-instructions" id="instructions-linux" style="display: none;">
                    <h4>Instalaci√≥n en Linux:</h4>
                    <ol>
                        <li>
                            <strong>Abre una terminal</strong>
                        </li>
                        <li>
                            <strong>Descarga el Agent:</strong><br>
                            <a href="/static/agent/maxide-agent.zip" download class="btn btn-sm btn-primary" style="margin: 8px 0;">
                                üì• Descargar MAX-IDE Agent
                            </a>
                        </li>
                        <li>
                            <strong>Ejecuta</strong> los siguientes comandos:
                        </li>
                    </ol>
                    <div class="agent-terminal">
                        <code>
                            # Instalar dependencias:<br>
                            pip install flask flask-cors pyserial requests<br><br>
                            # Agregar usuario al grupo dialout (puertos serial):<br>
                            sudo usermod -a -G dialout $USER<br><br>
                            # Ejecutar el agent:<br>
                            python3 agent.py<br><br>
                            # O para instalaci√≥n autom√°tica con autostart:<br>
                            python3 install.py
                        </code>
                    </div>
                </div>
                
                <div class="agent-install-footer">
                    <p><strong>¬øYa tienes el Agent instalado?</strong></p>
                    <button class="btn btn-primary" id="btnVerifyAgentInstall">
                        üîÑ Verificar conexi√≥n del Agent
                    </button>
                    <span class="agent-verify-status" id="agentVerifyStatus"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".xml,.maxide" style="display: none;">
    
    <!-- Modal Proyectos -->
    {% if user.is_authenticated %}
    <div class="modal-overlay" id="projectsModal" style="display: none;">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üì¶ Mis Proyectos</h2>
                <button class="modal-close" id="btnCloseProjects">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="btnCreateNewProject">‚ûï Crear Nuevo Proyecto</button>
                </div>
                <div id="projectsList" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #8b949e;">Cargando proyectos...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Crear Proyecto -->
    <div class="modal-overlay" id="createProjectModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï Crear Nuevo Proyecto</h2>
                <button class="modal-close" id="btnCloseCreateProject">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre del Proyecto *</label>
                    <input type="text" id="projectName" placeholder="Mi Proyecto Arduino" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #e6edf3;">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="projectDescription" placeholder="Descripci√≥n del proyecto..." style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #e6edf3; min-height: 80px;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" id="btnCancelCreateProject">Cancelar</button>
                    <button class="btn btn-primary" id="btnConfirmCreateProject">Crear</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Toolbox XML para Blockly -->
    <xml id="toolbox" style="display: none;">
        <category name="‚öôÔ∏è Estructura" colour="60">
            <block type="arduino_setup"></block>
            <block type="arduino_loop"></block>
        </category>
        
        <category name="üìå Digital" colour="230">
            <block type="arduino_pin_mode">
                <field name="PIN">13</field>
                <field name="MODE">OUTPUT</field>
            </block>
            <block type="arduino_digital_write">
                <field name="PIN">13</field>
                <field name="VALUE">HIGH</field>
            </block>
            <block type="arduino_digital_read">
                <field name="PIN">2</field>
            </block>
        </category>
        
        <category name="üìä Anal√≥gico" colour="180">
            <block type="arduino_analog_read">
                <field name="PIN">0</field>
            </block>
            <block type="arduino_analog_write">
                <field name="PIN">9</field>
                <value name="VALUE">
                    <block type="arduino_number">
                        <field name="NUM">128</field>
                    </block>
                </value>
            </block>
        </category>
        
        <category name="‚è±Ô∏è Tiempo" colour="330">
            <block type="arduino_delay">
                <value name="TIME">
                    <block type="arduino_number">
                        <field name="NUM">1000</field>
                    </block>
                </value>
            </block>
            <block type="arduino_delay_microseconds">
                <value name="TIME">
                    <block type="arduino_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="arduino_millis"></block>
            <block type="arduino_micros"></block>
        </category>
        
        <category name="üì° Serial" colour="20">
            <block type="arduino_serial_begin">
                <field name="BAUD">9600</field>
            </block>
            <block type="arduino_serial_print"></block>
            <block type="arduino_serial_println"></block>
            <block type="arduino_serial_available"></block>
            <block type="arduino_serial_read"></block>
        </category>
        
        <category name="üîÄ Control" colour="210">
            <block type="arduino_if"></block>
            <block type="arduino_if_else"></block>
            <block type="arduino_for">
                <field name="VAR">i</field>
                <field name="FROM">0</field>
                <field name="TO">10</field>
            </block>
            <block type="arduino_while"></block>
        </category>
        
        <category name="‚öñÔ∏è L√≥gica" colour="210">
            <block type="arduino_compare"></block>
            <block type="arduino_logic"></block>
            <block type="arduino_not"></block>
            <block type="arduino_true"></block>
            <block type="arduino_false"></block>
        </category>
        
        <category name="üî¢ Matem√°ticas" colour="200">
            <block type="arduino_number">
                <field name="NUM">0</field>
            </block>
            <block type="arduino_math"></block>
            <block type="arduino_map"></block>
            <block type="arduino_constrain"></block>
            <block type="arduino_random"></block>
        </category>
        
        <category name="üìù Variables" colour="290">
            <block type="arduino_variable_int"></block>
            <block type="arduino_variable_float"></block>
            <block type="arduino_variable_string"></block>
            <block type="arduino_variable_boolean"></block>
            <block type="arduino_get_variable"></block>
            <block type="arduino_set_variable"></block>
        </category>
        
        <category name="üìù Texto" colour="160">
            <block type="arduino_string">
                <field name="TEXT">Hola</field>
            </block>
        </category>
        
        <category name="üîß Componentes" colour="40">
            <block type="arduino_led_builtin">
                <field name="STATE">HIGH</field>
            </block>
            <block type="arduino_tone"></block>
            <block type="arduino_no_tone"></block>
        </category>
        
        <category name="ü¶æ Servos" colour="270">
            <block type="arduino_servo_attach">
                <field name="NAME">miServo</field>
                <field name="PIN">9</field>
            </block>
            <block type="arduino_servo_attach_limits">
                <field name="NAME">miServo</field>
                <field name="PIN">9</field>
                <field name="MIN">544</field>
                <field name="MAX">2400</field>
            </block>
            <block type="arduino_servo_write">
                <field name="NAME">miServo</field>
                <value name="ANGLE">
                    <block type="arduino_number">
                        <field name="NUM">90</field>
                    </block>
                </value>
            </block>
            <block type="arduino_servo_write_simple">
                <field name="NAME">miServo</field>
                <field name="ANGLE">90</field>
            </block>
            <block type="arduino_servo_write_microseconds">
                <field name="NAME">miServo</field>
                <value name="US">
                    <block type="arduino_number">
                        <field name="NUM">1500</field>
                    </block>
                </value>
            </block>
            <block type="arduino_servo_read">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_attached">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_detach">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_sweep">
                <field name="NAME">miServo</field>
                <field name="FROM">0</field>
                <field name="TO">180</field>
                <value name="DELAY">
                    <block type="arduino_number">
                        <field name="NUM">15</field>
                    </block>
                </value>
            </block>
        </category>
        
        <category name="‚ö° Avanzado" colour="0">
            <block type="arduino_include">
                <field name="LIBRARY">Servo.h</field>
            </block>
            <block type="arduino_custom_code"></block>
            <block type="arduino_comment"></block>
        </category>
    </xml>
    
    <!-- Scripts (timestamp = cache bust) -->
    <script src="{% static 'editor/js/arduino_blocks.js' %}?v={{ now }}"></script>
    <script src="{% static 'editor/js/arduino_generator.js' %}?v={{ now }}"></script>
    <script src="{% static 'editor/js/app.js' %}?v={{ now }}"></script>
    
    {% if project_xml %}
    <script>
        // Cargar proyecto desde template
        setTimeout(function() {
            if (typeof loadProjectFromTemplate === 'function') {
                loadProjectFromTemplate('{{ project_xml|escapejs }}', {{ project.id|default:"null" }});
            }
        }, 1000);
    </script>
    {% endif %}
</body>
</html>
