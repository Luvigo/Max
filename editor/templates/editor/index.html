{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAX-IDE | Arduino Block Editor</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Blockly -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="{% static 'editor/css/style.css' %}">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div class="logo-text">MAX-IDE</div>
                <span class="logo-badge">ARDUINO</span>
            </div>
            
            <div class="header-controls">
                <!-- Activity Status Badge (solo visible si hay actividad) -->
                <div id="activityStatusContainer" class="activity-status-container" style="display: none;">
                    <span class="activity-badge" id="submissionStatusBadge">
                        <span class="badge-inprogress">üü° En progreso</span>
                    </span>
                    <button class="btn btn-success btn-sm" id="btnSubmitActivity" style="display: none;">
                        üì§ Entregar
                    </button>
                </div>
                
                <!-- Board Selector -->
                <div class="control-group">
                    <label>
                        <span>üéØ</span>
                        Board
                    </label>
                    <select id="boardSelect">
                        <option value="arduino:avr:uno">Arduino UNO</option>
                        <option value="arduino:avr:nano">Arduino Nano</option>
                        <option value="arduino:avr:nano:cpu=atmega328old">Arduino Nano (Old Bootloader)</option>
                        <option value="arduino:avr:mega">Arduino Mega</option>
                        <option value="arduino:avr:leonardo">Arduino Leonardo</option>
                    </select>
                </div>
                
                <!-- Port Selector -->
                <div class="control-group">
                    <label>
                        <span>üîå</span>
                        Puerto
                    </label>
                    <select id="portSelect">
                        <option value="">Seleccionar...</option>
                    </select>
                    <button class="btn btn-icon-only btn-ghost" id="btnAddPort" title="Agregar nuevo puerto">
                        ‚ûï
                    </button>
                    <button class="btn btn-icon-only btn-ghost" id="btnRefreshPorts" title="Actualizar puertos">
                        üîÑ
                    </button>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-ghost" id="btnSerialMonitor" title="Monitor Serial">
                        <span>üìü</span>
                        <span>Serial</span>
                    </button>
                    <button class="btn btn-warning" id="btnCompile" data-action="verify">
                        <span>‚öôÔ∏è</span>
                        <span>Verificar</span>
                    </button>
                    <button class="btn btn-success" id="btnUpload" data-action="upload">
                        <span>üöÄ</span>
                        <span>Subir</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Workspace de Blockly -->
            <div class="workspace-container">
                <div class="workspace-header">
                    <div class="workspace-tabs">
                        <button class="workspace-tab active">
                            <span>üì¶</span>
                            Bloques
                        </button>
                    </div>
                    <div class="workspace-actions">
                        <button class="btn btn-sm btn-ghost" id="btnNew" title="Nuevo proyecto">
                            üìÑ Nuevo
                        </button>
                        {% if user.is_authenticated %}
                        <button class="btn btn-sm btn-ghost" id="btnSaveProject" title="Guardar Proyecto">
                            üíæ Guardar Proyecto
                        </button>
                        <button class="btn btn-sm btn-ghost" id="btnLoadProject" title="Cargar Proyecto">
                            üìÇ Mis Proyectos
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-ghost" id="btnSave" title="Guardar archivo local">
                            üíæ Guardar Local
                        </button>
                        <button class="btn btn-sm btn-ghost" id="btnLoad" title="Cargar archivo local">
                            üìÇ Cargar Local
                        </button>
                    </div>
                </div>
                
                <div id="blocklyDiv"></div>
            </div>
            
            <!-- Panel de c√≥digo -->
            <div class="code-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <span class="icon">&lt;/&gt;</span>
                        C√≥digo Arduino
                    </h3>
                    <button class="btn btn-sm btn-ghost" id="btnCopyCode" title="Copiar c√≥digo">
                        üìã Copiar
                    </button>
                </div>
                <div class="code-content">
                    <pre><code id="codeOutput">// El c√≥digo aparecer√° aqu√≠
// Arrastra bloques para empezar

void setup() {
  
}

void loop() {
  
}</code></pre>
                </div>
                
                <!-- Console -->
                <div class="console-panel">
                    <div class="console-header">
                        <h4>
                            <span>üìü</span>
                            Consola
                        </h4>
                        <button class="btn btn-sm btn-ghost" id="btnClearConsole">Limpiar</button>
                    </div>
                    <div class="console-content" id="consoleOutput">
                        <div class="console-line info">
                            <span class="console-time">[00:00]</span>
                            <span>MAX-IDE listo. ¬°Arrastra bloques para empezar!</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Agent Install Banner -->
        <div class="agent-banner" id="agentBanner" style="display: none;">
            <div class="agent-banner-content">
                <div class="agent-banner-icon">üîß</div>
                <div class="agent-banner-text">
                    <strong>Agent local requerido para subir c√≥digo</strong>
                    <span>Instala el MAX-IDE Agent en tu PC para poder subir c√≥digo al Arduino</span>
                </div>
                <div class="agent-banner-actions">
                    <button class="btn btn-sm btn-ghost" id="btnCheckAgent">
                        üîÑ Verificar conexi√≥n
                    </button>
                    <button class="btn btn-sm btn-primary" id="btnInstallAgent">
                        üì• Instrucciones de instalaci√≥n
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span class="status-dot disconnected" id="statusDot"></span>
                    <span id="statusText">Sin conexi√≥n</span>
                </div>
                <div class="status-item">
                    <span>üì¶</span>
                    <span id="blockCount">0 bloques</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item" id="agentStatus">
                    <span class="status-dot disconnected" id="agentStatusDot"></span>
                    <span id="agentStatusText">Agent: Verificando...</span>
                </div>
                <div class="status-item" id="boardInfo">
                    <span>üéØ</span>
                    <span>Arduino UNO</span>
                </div>
                <div class="status-item">
                    MAX-IDE v1.0
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Modal Monitor Serial -->
    <div class="modal-overlay" id="serialModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">üìü</span>
                    Monitor Serial
                </h2>
                <button class="modal-close" id="btnCloseSerial">&times;</button>
            </div>
            <div class="modal-body">
                <div class="serial-controls">
                    <div class="control-group">
                        <label>Puerto (Web Serial API)</label>
                        <select id="serialPortSelect" disabled>
                            <option value="">Usa "Conectar" para seleccionar puerto</option>
                        </select>
                        <small style="color: #888; font-size: 11px;">El puerto se selecciona al hacer clic en "Conectar"</small>
                    </div>
                    <div class="control-group">
                        <label>Baudrate</label>
                        <select id="serialBaudrate">
                            <option value="9600">9600</option>
                            <option value="115200">115200</option>
                            <option value="57600">57600</option>
                            <option value="38400">38400</option>
                            <option value="19200">19200</option>
                            <option value="4800">4800</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="btnSerialConnect">
                        <span>üîó</span>
                        Conectar
                    </button>
                    <button class="btn btn-danger hidden" id="btnSerialDisconnect">
                        <span>‚õî</span>
                        Desconectar
                    </button>
                    <div class="connection-status disconnected" id="serialStatus">
                        <span class="status-dot disconnected"></span>
                        <span>Desconectado</span>
                    </div>
                    <div class="flex-1"></div>
                    <button class="btn btn-sm btn-ghost" id="btnClearSerial">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                <div class="serial-output" id="serialOutput">
                    <div class="line system">Esperando conexi√≥n...</div>
                </div>
                <div class="serial-input-container">
                    <input type="text" class="serial-input" id="serialInput" placeholder="Escribe un mensaje y presiona Enter..." disabled>
                    <button class="btn btn-primary" id="btnSerialSend" disabled>
                        Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Modal Instalar Agent -->
    <div class="modal-overlay" id="agentInstallModal" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">üîß</span>
                    Instalar MAX-IDE Agent
                </h2>
                <button class="modal-close" id="btnCloseAgentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="agent-install-intro">
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üîå</div>
                        <p style="font-size: 1.1rem; margin: 0;">El <strong style="color: var(--accent-cyan);">MAX-IDE Agent</strong> conecta tu Arduino con el navegador.</p>
                        <p style="color: var(--text-muted); margin-top: 8px;">¬°Solo necesitas instalarlo una vez!</p>
                    </div>
                </div>
                
                <div class="agent-install-tabs">
                    <button class="agent-tab active" data-os="windows">ü™ü Windows</button>
                    <button class="agent-tab" data-os="mac">üçé macOS</button>
                    <button class="agent-tab" data-os="linux">üêß Linux</button>
                </div>
                
                <!-- Windows Instructions - SIMPLIFICADO con winget -->
                <div class="agent-instructions" id="instructions-windows">
                    <div class="install-steps">
                        <div class="install-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <div class="step-title">Descarga el Agent</div>
                                <div class="step-desc">Haz clic en el bot√≥n para descargar:</div>
                                <a href="/static/agent/maxide-agent.zip" download class="btn btn-primary" style="margin-top: 10px; padding: 12px 24px; font-size: 1rem;">
                                    üì• Descargar MAX-IDE Agent
                                </a>
                                <div class="step-note">üì¶ Archivo peque√±o (~50 KB)</div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <div class="step-title">Extrae y ejecuta</div>
                                <div class="step-desc">Clic derecho en el ZIP ‚Üí <strong>"Extraer todo"</strong>, luego abre la carpeta y haz <strong>doble clic</strong> en:</div>
                                <div class="step-file" style="font-size: 1.1rem; padding: 10px 16px; margin: 10px 0;">‚ñ∂Ô∏è start_agent.bat</div>
                                <div class="step-note">üí° Se abrir√° una ventana negra - ¬°no la cierres!</div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <div class="step-title">¬°Espera la instalaci√≥n autom√°tica!</div>
                                <div class="step-desc">La primera vez instalar√° <strong>Python</strong> y <strong>Arduino CLI</strong> autom√°ticamente.</div>
                                <div class="step-note">‚è±Ô∏è La instalaci√≥n toma menos de un minuto.</div>
                                <div class="step-note" style="margin-top: 8px;">‚ö†Ô∏è Si pide cerrar y volver a abrir, hazlo. Es normal la primera vez.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="install-success-box" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.2)); border: 1px solid #10b981;">
                        <div style="font-size: 28px;">üéâ</div>
                        <div>
                            <strong style="font-size: 1.05rem;">¬°Solo descarga, extrae y doble clic!</strong><br>
                            <span style="opacity: 0.9;">El instalador configura todo autom√°ticamente.</span>
                        </div>
                    </div>
                </div>
                
                <!-- macOS Instructions -->
                <div class="agent-instructions" id="instructions-mac" style="display: none;">
                    <div class="install-steps">
                        <div class="install-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <div class="step-title">Instala Homebrew (si no lo tienes)</div>
                                <div class="step-desc">Abre Terminal (<kbd>Cmd</kbd> + <kbd>Espacio</kbd> ‚Üí escribe "Terminal") y ejecuta:</div>
                                <div class="agent-terminal" style="margin-top: 10px;">
                                    <code>/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"</code>
                                </div>
                                <div class="step-note">üí° Sigue las instrucciones en pantalla. Te pedir√° tu contrase√±a.</div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <div class="step-title">Agrega Homebrew al PATH</div>
                                <div class="step-desc">Cuando termine la instalaci√≥n, Homebrew te mostrar√° una secci√≥n <strong>"Next steps"</strong> con comandos personalizados para tu Mac. <strong>Copia y ejecuta esos comandos</strong> (son 2-3 l√≠neas que empiezan con <code>echo</code> y <code>eval</code>).</div>
                                <div class="step-note">‚ö†Ô∏è Importante: Cierra y vuelve a abrir Terminal despu√©s de ejecutar los comandos.</div>
                                <div class="step-note">üí° Verifica que funcion√≥ ejecutando: <code>brew --version</code></div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <div class="step-title">Instala Arduino CLI</div>
                                <div class="step-desc">En una nueva ventana de Terminal, ejecuta:</div>
                                <div class="agent-terminal" style="margin-top: 10px;">
                                    <code>brew install arduino-cli<br>arduino-cli core update-index<br>arduino-cli core install arduino:avr</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <div class="step-title">Descarga el Agent</div>
                                <a href="/static/agent/maxide-agent.zip" download class="btn btn-primary" style="margin-top: 8px;">
                                    üì• Descargar MAX-IDE Agent
                                </a>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <div class="step-title">Descomprime y ejecuta</div>
                                <div class="step-desc">Descomprime el ZIP (doble clic), luego en Terminal:</div>
                                <div class="agent-terminal" style="margin-top: 10px;">
                                    <code>cd ~/Downloads/maxide-agent<br>bash start_agent.sh</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="install-success-box">
                        <div style="font-size: 24px;">‚úÖ</div>
                        <div>
                            <strong>¬°Listo!</strong> Cuando veas "Listening on http://localhost:8765", 
                            haz clic en "Verificar conexi√≥n" abajo.
                        </div>
                    </div>
                </div>
                
                <!-- Linux Instructions -->
                <div class="agent-instructions" id="instructions-linux" style="display: none;">
                    <div class="install-steps">
                        <div class="install-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <div class="step-title">Instala arduino-cli (si no lo tienes)</div>
                                <div class="step-desc">Copia y pega en Terminal (<kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>T</kbd>):</div>
                                <div class="agent-terminal" style="margin-top: 10px;">
                                    <code>curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh<br>sudo mv bin/arduino-cli /usr/local/bin/<br>arduino-cli core update-index<br>arduino-cli core install arduino:avr</code>
                                </div>
                                <div class="step-note">‚ö†Ô∏è NO uses snap. La versi√≥n snap tiene problemas de permisos con puertos seriales.</div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <div class="step-title">Permisos para puertos serial</div>
                                <div class="step-desc">Ejecuta esto y luego <strong>cierra sesi√≥n y vuelve a entrar</strong>:</div>
                                <div class="agent-terminal" style="margin-top: 10px;">
                                    <code>sudo usermod -a -G dialout $USER</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <div class="step-title">Descarga el Agent</div>
                                <a href="/static/agent/maxide-agent.zip" download class="btn btn-primary" style="margin-top: 8px;">
                                    üì• Descargar MAX-IDE Agent
                                </a>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <div class="step-title">Ejecuta el Agent</div>
                                <div class="step-desc">Copia y pega en Terminal:</div>
                                <div class="agent-terminal" style="margin-top: 10px;">
                                    <code>cd ~/Downloads && unzip -o maxide-agent.zip && cd maxide-agent && bash start_agent.sh</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="install-success-box">
                        <div style="font-size: 24px;">‚úÖ</div>
                        <div>
                            <strong>¬°Listo!</strong> Cuando veas "Listening on http://localhost:8765", 
                            haz clic en "Verificar conexi√≥n" abajo.
                        </div>
                    </div>
                </div>
                
                <div class="agent-install-footer">
                    <button class="btn btn-primary btn-lg" id="btnVerifyAgentInstall" style="padding: 14px 28px; font-size: 1rem;">
                        üîÑ Verificar conexi√≥n del Agent
                    </button>
                    <span class="agent-verify-status" id="agentVerifyStatus"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".xml,.maxide" style="display: none;">
    
    <!-- Modal Proyectos -->
    {% if user.is_authenticated %}
    <div class="modal-overlay" id="projectsModal" style="display: none;">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üì¶ Mis Proyectos</h2>
                <button class="modal-close" id="btnCloseProjects">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="btnCreateNewProject">‚ûï Crear Nuevo Proyecto</button>
                </div>
                <div id="projectsList" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #8b949e;">Cargando proyectos...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Crear Proyecto -->
    <div class="modal-overlay" id="createProjectModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï Crear Nuevo Proyecto</h2>
                <button class="modal-close" id="btnCloseCreateProject">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre del Proyecto *</label>
                    <input type="text" id="projectName" placeholder="Mi Proyecto Arduino" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #e6edf3;">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="projectDescription" placeholder="Descripci√≥n del proyecto..." style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #e6edf3; min-height: 80px;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" id="btnCancelCreateProject">Cancelar</button>
                    <button class="btn btn-primary" id="btnConfirmCreateProject">Crear</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Toolbox XML para Blockly -->
    <xml id="toolbox" style="display: none;">
        <category name="‚öôÔ∏è Estructura" colour="60">
            <block type="arduino_setup"></block>
            <block type="arduino_loop"></block>
        </category>
        
        <category name="üìå Digital" colour="230">
            <block type="arduino_pin_mode">
                <field name="PIN">13</field>
                <field name="MODE">OUTPUT</field>
            </block>
            <block type="arduino_digital_write">
                <field name="PIN">13</field>
                <field name="VALUE">HIGH</field>
            </block>
            <block type="arduino_digital_read">
                <field name="PIN">2</field>
            </block>
        </category>
        
        <category name="üìä Anal√≥gico" colour="180">
            <block type="arduino_analog_read">
                <field name="PIN">0</field>
            </block>
            <block type="arduino_analog_write">
                <field name="PIN">9</field>
                <value name="VALUE">
                    <block type="arduino_number">
                        <field name="NUM">128</field>
                    </block>
                </value>
            </block>
        </category>
        
        <category name="‚è±Ô∏è Tiempo" colour="330">
            <block type="arduino_delay">
                <value name="TIME">
                    <block type="arduino_number">
                        <field name="NUM">1000</field>
                    </block>
                </value>
            </block>
            <block type="arduino_delay_microseconds">
                <value name="TIME">
                    <block type="arduino_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="arduino_millis"></block>
            <block type="arduino_micros"></block>
        </category>
        
        <category name="üì° Serial" colour="20">
            <block type="arduino_serial_begin">
                <field name="BAUD">9600</field>
            </block>
            <block type="arduino_serial_print"></block>
            <block type="arduino_serial_println"></block>
            <block type="arduino_serial_available"></block>
            <block type="arduino_serial_read"></block>
        </category>
        
        <category name="üîÄ Control" colour="210">
            <label text="‚îÄ‚îÄ Condicionales ‚îÄ‚îÄ"></label>
            <block type="arduino_if"></block>
            <block type="arduino_if_else"></block>
            <block type="arduino_if_elseif"></block>
            <block type="arduino_if_elseif_else"></block>
            <block type="arduino_if_elseif2_else"></block>
            <label text="‚îÄ‚îÄ Ciclos ‚îÄ‚îÄ"></label>
            <block type="arduino_for">
                <field name="VAR">i</field>
                <field name="FROM">0</field>
                <field name="TO">10</field>
            </block>
            <block type="arduino_while"></block>
        </category>
        
        <category name="‚öñÔ∏è L√≥gica" colour="210">
            <block type="arduino_compare"></block>
            <block type="arduino_and"></block>
            <block type="arduino_or"></block>
            <block type="arduino_and3"></block>
            <block type="arduino_or3"></block>
            <block type="arduino_and_or"></block>
            <block type="arduino_or_and"></block>
            <block type="arduino_logic"></block>
            <block type="arduino_not"></block>
            <block type="arduino_true"></block>
            <block type="arduino_false"></block>
        </category>
        
        <category name="üî¢ Matem√°ticas" colour="200">
            <block type="arduino_number">
                <field name="NUM">0</field>
            </block>
            <block type="arduino_math"></block>
            <block type="arduino_map"></block>
            <block type="arduino_constrain"></block>
            <block type="arduino_random"></block>
        </category>
        
        <category name="üìù Variables" colour="290">
            <block type="arduino_variable_int"></block>
            <block type="arduino_variable_float"></block>
            <block type="arduino_variable_string"></block>
            <block type="arduino_variable_boolean"></block>
            <block type="arduino_get_variable"></block>
            <block type="arduino_set_variable"></block>
        </category>
        
        <category name="üìù Texto" colour="160">
            <block type="arduino_string">
                <field name="TEXT">Hola</field>
            </block>
        </category>
        
        <category name="üîß Componentes" colour="40">
            <block type="arduino_led_builtin">
                <field name="STATE">HIGH</field>
            </block>
            <block type="arduino_tone"></block>
            <block type="arduino_no_tone"></block>
        </category>
        
        <category name="ü¶æ Servos" colour="270">
            <block type="arduino_servo_attach">
                <field name="NAME">miServo</field>
                <field name="PIN">9</field>
            </block>
            <block type="arduino_servo_attach_limits">
                <field name="NAME">miServo</field>
                <field name="PIN">9</field>
                <field name="MIN">544</field>
                <field name="MAX">2400</field>
            </block>
            <block type="arduino_servo_write">
                <field name="NAME">miServo</field>
                <value name="ANGLE">
                    <block type="arduino_number">
                        <field name="NUM">90</field>
                    </block>
                </value>
            </block>
            <block type="arduino_servo_write_simple">
                <field name="NAME">miServo</field>
                <field name="ANGLE">90</field>
            </block>
            <block type="arduino_servo_write_microseconds">
                <field name="NAME">miServo</field>
                <value name="US">
                    <block type="arduino_number">
                        <field name="NUM">1500</field>
                    </block>
                </value>
            </block>
            <block type="arduino_servo_read">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_attached">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_detach">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_sweep">
                <field name="NAME">miServo</field>
                <field name="FROM">0</field>
                <field name="TO">180</field>
                <value name="DELAY">
                    <block type="arduino_number">
                        <field name="NUM">15</field>
                    </block>
                </value>
            </block>
        </category>
        
        <!-- ============================================ -->
        <!-- üöó CARRITO MAX - Bloques especiales -->
        <!-- ============================================ -->
        
        <category name="üöó Carrito MAX" colour="190" expanded="false">
            <category name="‚öôÔ∏è Inicializaci√≥n" colour="190">
                <block type="max_init_motores">
                    <field name="PIN_IZQ">9</field>
                    <field name="PIN_DER">10</field>
                </block>
                <block type="max_init_distancia">
                    <field name="PIN_TRIG">6</field>
                    <field name="PIN_ECHO">7</field>
                </block>
                <block type="max_init_lineas">
                    <field name="PIN_IZQ">0</field>
                    <field name="PIN_CENT">1</field>
                    <field name="PIN_DER">2</field>
                </block>
                <block type="max_init_buzzer">
                    <field name="PIN">3</field>
                </block>
                <block type="max_init_garra">
                    <field name="PIN">11</field>
                    <field name="CERRADA">0</field>
                    <field name="ABIERTA">90</field>
                </block>
            </category>
            
            <category name="üèéÔ∏è Movimiento" colour="120">
                <block type="max_adelante">
                    <field name="VEL">30</field>
                </block>
                <block type="max_atras">
                    <field name="VEL">30</field>
                </block>
                <block type="max_izquierda">
                    <field name="VEL">25</field>
                </block>
                <block type="max_derecha">
                    <field name="VEL">25</field>
                </block>
                <block type="max_detener"></block>
                <block type="max_adelante_var"></block>
                <block type="max_atras_var"></block>
                <block type="max_izquierda_var"></block>
                <block type="max_derecha_var"></block>
                <block type="max_avanzar_tiempo">
                    <field name="VEL">30</field>
                    <field name="TIEMPO">1000</field>
                </block>
                <block type="max_retroceder_tiempo">
                    <field name="VEL">30</field>
                    <field name="TIEMPO">1000</field>
                </block>
                <block type="max_girar_tiempo">
                    <field name="DIR">izquierda</field>
                    <field name="VEL">25</field>
                    <field name="TIEMPO">500</field>
                </block>
            </category>
            
            <category name="üì° Sensor Distancia" colour="230">
                <block type="max_medir_distancia"></block>
                <block type="max_distancia_menor_que">
                    <field name="CM">20</field>
                </block>
                <block type="max_distancia_mayor_que">
                    <field name="CM">30</field>
                </block>
                <block type="max_evitar_obstaculo">
                    <field name="DISTANCIA">20</field>
                </block>
            </category>
            
            <category name="‚ûñ Sensor L√≠neas" colour="60">
                <block type="max_leer_linea_izq"></block>
                <block type="max_leer_linea_centro"></block>
                <block type="max_leer_linea_der"></block>
                <block type="max_linea_detectada">
                    <field name="SENSOR">CENT</field>
                    <field name="UMBRAL">500</field>
                </block>
                <block type="max_linea_comparar">
                    <field name="SENSOR">CENT</field>
                    <field name="OP"><</field>
                    <field name="UMBRAL">500</field>
                </block>
                <block type="max_linea_valor_comparar">
                    <field name="SENSOR">CENT</field>
                    <field name="OP"><</field>
                </block>
            </category>
            
            <category name="üéµ Buzzer/Sonido" colour="300">
                <block type="max_tocar_nota">
                    <field name="NOTA">262</field>
                    <field name="DURACION">300</field>
                </block>
                <block type="max_tocar_frecuencia">
                    <value name="FREQ">
                        <block type="arduino_number">
                            <field name="NUM">440</field>
                        </block>
                    </value>
                    <value name="DURACION">
                        <block type="arduino_number">
                            <field name="NUM">300</field>
                        </block>
                    </value>
                </block>
                <block type="max_beep"></block>
                <block type="max_detener_sonido"></block>
            </category>
            
            <category name="ü¶æ Garra" colour="45">
                <block type="max_abrir_garra"></block>
                <block type="max_cerrar_garra"></block>
                <block type="max_mover_garra">
                    <field name="ANGULO">45</field>
                </block>
            </category>
        </category>
        
        <category name="‚ö° Avanzado" colour="0">
            <block type="arduino_include">
                <field name="LIBRARY">Servo.h</field>
            </block>
            <block type="arduino_custom_code"></block>
            <block type="arduino_comment"></block>
        </category>
    </xml>
    
    <!-- Scripts (timestamp = cache bust) -->
    <script src="{% static 'editor/js/arduino_blocks.js' %}?v={{ now }}"></script>
    <script src="{% static 'editor/js/arduino_generator.js' %}?v={{ now }}"></script>
    <script src="{% static 'editor/js/app.js' %}?v={{ now }}"></script>
    
    {% if project_xml %}
    <script>
        // Cargar proyecto desde template
        setTimeout(function() {
            if (typeof loadProjectFromTemplate === 'function') {
                loadProjectFromTemplate('{{ project_xml|escapejs }}', {{ project.id|default:"null" }});
            }
        }, 1000);
    </script>
    {% endif %}
    
    <!-- Modal de confirmaci√≥n de entrega (P3.1) -->
    <div class="submit-modal-overlay" id="submitModalOverlay">
        <div class="submit-modal">
            <h3>üì§ Confirmar Entrega</h3>
            <p id="submitModalMessage">
                ¬øEst√°s seguro de que quieres entregar esta actividad?
            </p>
            <div class="submit-status-message" id="submitStatusMessage"></div>
            <div class="submit-modal-actions">
                <button class="btn btn-cancel" id="btnCancelSubmit">Cancelar</button>
                <button class="btn btn-confirm" id="btnConfirmSubmit">
                    <span id="btnConfirmSubmitText">Entregar</span>
                </button>
            </div>
        </div>
    </div>
    
    <script>
    // Sistema de entrega de actividades (P3.1)
    (function() {
        // Solo inicializar si hay IDE_CONFIG con actividad
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initActivitySubmitSystem, 500);
        });
        
        function initActivitySubmitSystem() {
            // Verificar si hay contexto de actividad
            if (typeof IDE_CONFIG === 'undefined' || !IDE_CONFIG.activityId) {
                console.debug('[Submit] No hay contexto de actividad');
                return;
            }
            
            console.debug('[Submit] Inicializando sistema de entrega para actividad:', IDE_CONFIG.activityId);
            
            // Mostrar contenedor de estado
            const statusContainer = document.getElementById('activityStatusContainer');
            const submitBtn = document.getElementById('btnSubmitActivity');
            const badge = document.getElementById('submissionStatusBadge');
            
            if (statusContainer) {
                statusContainer.style.display = 'flex';
            }
            
            // Mostrar bot√≥n si puede entregar
            if (submitBtn && IDE_CONFIG.canSubmit && !IDE_CONFIG.isReadOnly && !IDE_CONFIG.isFrozen) {
                submitBtn.style.display = 'inline-flex';
                submitBtn.addEventListener('click', openSubmitModal);
            }
            
            // Actualizar badge seg√∫n estado actual
            updateBadgeFromConfig();
            
            // Event listeners del modal
            document.getElementById('btnCancelSubmit')?.addEventListener('click', closeSubmitModal);
            document.getElementById('btnConfirmSubmit')?.addEventListener('click', performSubmit);
            document.getElementById('submitModalOverlay')?.addEventListener('click', function(e) {
                if (e.target === this) closeSubmitModal();
            });
        }
        
        function updateBadgeFromConfig() {
            const badge = document.getElementById('submissionStatusBadge');
            if (!badge) return;
            
            // Detectar estado desde IDE_CONFIG o desde la p√°gina
            if (IDE_CONFIG.isFrozen || IDE_CONFIG.isReadOnly) {
                if (IDE_CONFIG.submissionStatus === 'graded') {
                    badge.innerHTML = '<span class="badge-graded">üü¢ Calificada</span>';
                } else {
                    badge.innerHTML = '<span class="badge-submitted">üîµ Entregada</span>';
                }
            } else {
                badge.innerHTML = '<span class="badge-inprogress">üü° En progreso</span>';
            }
        }
        
        window.openSubmitModal = function() {
            const modal = document.getElementById('submitModalOverlay');
            const statusMsg = document.getElementById('submitStatusMessage');
            const confirmBtn = document.getElementById('btnConfirmSubmit');
            const confirmText = document.getElementById('btnConfirmSubmitText');
            
            // Reset estado
            if (statusMsg) {
                statusMsg.className = 'submit-status-message';
                statusMsg.textContent = '';
            }
            if (confirmBtn) confirmBtn.disabled = false;
            if (confirmText) confirmText.textContent = 'Entregar';
            
            // Actualizar mensaje
            const msgEl = document.getElementById('submitModalMessage');
            if (msgEl) {
                let msg = '¬øEst√°s seguro de que quieres entregar esta actividad?';
                if (IDE_CONFIG.allowResubmit === false) {
                    msg += '<br><strong>‚ö†Ô∏è Nota:</strong> Esta actividad no permite re-entregas. Una vez entregada, no podr√°s editarla.';
                }
                msgEl.innerHTML = msg;
            }
            
            if (modal) modal.classList.add('active');
        };
        
        window.closeSubmitModal = function() {
            const modal = document.getElementById('submitModalOverlay');
            if (modal) modal.classList.remove('active');
        };
        
        window.performSubmit = async function() {
            const confirmBtn = document.getElementById('btnConfirmSubmit');
            const confirmText = document.getElementById('btnConfirmSubmitText');
            const statusMsg = document.getElementById('submitStatusMessage');
            
            if (confirmBtn) confirmBtn.disabled = true;
            if (confirmText) confirmText.innerHTML = '<span class="mini-spinner"></span> Entregando...';
            if (statusMsg) statusMsg.className = 'submit-status-message';
            
            try {
                // Obtener URL de submit
                const submitUrl = IDE_CONFIG.submitUrl || 
                    `/i/${IDE_CONFIG.institutionSlug}/student/activities/${IDE_CONFIG.activityId}/submit/`;
                
                // Crear FormData
                const formData = new FormData();
                formData.append('project_id', IDE_CONFIG.projectId || currentProjectId || '');
                
                const response = await fetch(submitUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': IDE_CONFIG.csrfToken || getCsrfToken()
                    },
                    body: formData
                });
                
                if (response.redirected || response.ok) {
                    // √âxito
                    if (statusMsg) {
                        statusMsg.className = 'submit-status-message show success';
                        statusMsg.textContent = '‚úì ¬°Actividad entregada exitosamente!';
                    }
                    if (confirmText) confirmText.textContent = '‚úì Entregado';
                    
                    // Actualizar badge
                    const badge = document.getElementById('submissionStatusBadge');
                    if (badge) {
                        badge.innerHTML = '<span class="badge-submitted">üîµ Entregada</span>';
                    }
                    
                    // Ocultar bot√≥n de entregar si no permite re-entrega
                    if (!IDE_CONFIG.allowResubmit) {
                        const submitBtn = document.getElementById('btnSubmitActivity');
                        if (submitBtn) submitBtn.style.display = 'none';
                    }
                    
                    // Recargar despu√©s de un momento
                    setTimeout(() => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            window.location.reload();
                        }
                    }, 1500);
                } else {
                    throw new Error('Error en la respuesta del servidor');
                }
            } catch (error) {
                if (statusMsg) {
                    statusMsg.className = 'submit-status-message show error';
                    statusMsg.textContent = '‚úó Error al entregar: ' + (error.message || 'Intenta de nuevo');
                }
                if (confirmBtn) confirmBtn.disabled = false;
                if (confirmText) confirmText.textContent = 'Reintentar';
            }
        };
    })();
    </script>
</body>
</html>
