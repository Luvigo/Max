{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ activity.title }} - MAX-IDE</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Blockly -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="{% static 'editor/css/style.css' %}">
    
    <style>
        .activity-context-bar {
            background: linear-gradient(135deg, #1a1f35 0%, #0d1117 100%);
            border-bottom: 1px solid #30363d;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .activity-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #8b949e;
        }
        .activity-breadcrumb a {
            color: #58a6ff;
            text-decoration: none;
        }
        .activity-breadcrumb a:hover {
            text-decoration: underline;
        }
        .activity-breadcrumb .separator {
            color: #484f58;
        }
        .activity-title {
            color: #e6edf3;
            font-weight: 600;
        }
        .activity-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .activity-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-inprogress {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
        }
        .badge-submitted {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }
        .badge-graded {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
        }
        .badge-readonly {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }
        .readonly-alert {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: #f85149;
            padding: 8px 20px;
            font-size: 13px;
            text-align: center;
        }
        /* Modal de entrega */
        .submit-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .submit-modal-overlay.active {
            display: flex;
        }
        .submit-modal {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            padding: 24px;
        }
        .submit-modal h3 {
            margin: 0 0 16px 0;
            font-size: 1.2rem;
        }
        .submit-modal p {
            color: #8b949e;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }
        .submit-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .submit-status-message {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
        .submit-status-message.show {
            display: block;
        }
        .submit-status-message.success {
            background: rgba(46, 160, 67, 0.15);
            color: #3fb950;
        }
        .submit-status-message.error {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Activity Context Bar -->
        <div class="activity-context-bar">
            <div class="activity-breadcrumb">
                <a href="{% url 'student_dashboard' slug=institution.slug %}">{{ institution.name }}</a>
                <span class="separator">/</span>
                <a href="{% url 'editor:student_activities_list' institution_slug=institution.slug course_id=activity.course.id %}">{{ activity.course.name }}</a>
                <span class="separator">/</span>
                <span class="activity-title">{{ activity.title }}</span>
            </div>
            <div class="activity-actions">
                <span class="activity-badge {% if last_submission.status == 'graded' %}badge-graded{% elif last_submission.status == 'submitted' %}badge-submitted{% else %}badge-inprogress{% endif %}">
                    {% if last_submission.status == 'graded' %}üü¢ Calificada
                    {% elif last_submission.status == 'submitted' %}üîµ Entregada
                    {% else %}üü° En progreso{% endif %}
                </span>
                {% if is_frozen or is_read_only %}
                <span class="activity-badge badge-readonly">üîí Solo Lectura</span>
                {% endif %}
                {% if can_submit and not is_frozen %}
                <button class="btn btn-success btn-sm" id="btnSubmitActivity">üì§ Entregar</button>
                {% endif %}
            </div>
        </div>
        
        {% if is_frozen or is_read_only %}
        <div class="readonly-alert">
            ‚ö†Ô∏è <strong>Modo Solo Lectura:</strong>
            {% if is_frozen %}Este workspace est√° congelado.
            {% elif activity.is_closed %}Esta actividad est√° cerrada.
            {% else %}La fecha l√≠mite ya pas√≥.{% endif %}
        </div>
        {% endif %}
        
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div class="logo-text">MAX-IDE</div>
                <span class="logo-badge">ARDUINO</span>
            </div>
            
            <div class="header-controls">
                <!-- Board Selector -->
                <div class="control-group">
                    <label><span>üéØ</span> Board</label>
                    <select id="boardSelect">
                        <option value="arduino:avr:uno">Arduino UNO</option>
                        <option value="arduino:avr:nano">Arduino Nano</option>
                        <option value="arduino:avr:nano:cpu=atmega328old">Arduino Nano (Old Bootloader)</option>
                        <option value="arduino:avr:mega">Arduino Mega</option>
                    </select>
                </div>
                
                <!-- Port Selector -->
                <div class="control-group">
                    <label><span>üîå</span> Puerto</label>
                    <select id="portSelect">
                        <option value="">Seleccionar...</option>
                    </select>
                    <button class="btn btn-icon-only btn-ghost" id="btnRefreshPorts" title="Actualizar puertos">üîÑ</button>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-ghost" id="btnSerialMonitor" title="Monitor Serial">
                        <span>üìü</span><span>Serial</span>
                    </button>
                    <button class="btn btn-warning" id="btnCompile" data-action="verify" {% if is_read_only %}disabled{% endif %}>
                        <span>‚öôÔ∏è</span><span>Verificar</span>
                    </button>
                    <button class="btn btn-success" id="btnUpload" data-action="upload" {% if is_read_only %}disabled{% endif %}>
                        <span>üöÄ</span><span>Subir</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Workspace de Blockly -->
            <div class="workspace-container">
                <div class="workspace-header">
                    <div class="workspace-tabs">
                        <button class="workspace-tab active"><span>üì¶</span> Bloques</button>
                    </div>
                    <div class="workspace-actions">
                        {% if not is_read_only %}
                        <span id="autosaveIndicator" style="font-size: 12px; color: #8b949e;"></span>
                        {% endif %}
                    </div>
                </div>
                <div id="blocklyDiv"></div>
            </div>
            
            <!-- Panel de c√≥digo -->
            <div class="code-panel">
                <div class="panel-header">
                    <h3 class="panel-title"><span class="icon">&lt;/&gt;</span> C√≥digo Arduino</h3>
                    <button class="btn btn-sm btn-ghost" id="btnCopyCode" title="Copiar c√≥digo">üìã Copiar</button>
                </div>
                <div class="code-content">
                    <pre><code id="codeOutput">// El c√≥digo aparecer√° aqu√≠</code></pre>
                </div>
                
                <!-- Console -->
                <div class="console-panel">
                    <div class="console-header">
                        <h4><span>üìü</span> Consola</h4>
                        <button class="btn btn-sm btn-ghost" id="btnClearConsole">Limpiar</button>
                    </div>
                    <div class="console-content" id="consoleOutput">
                        <div class="console-line info">
                            <span class="console-time">[00:00]</span>
                            <span>MAX-IDE listo - Actividad: {{ activity.title }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span class="status-dot disconnected" id="statusDot"></span>
                    <span id="statusText">Sin conexi√≥n</span>
                </div>
                <div class="status-item">
                    <span>üì¶</span>
                    <span id="blockCount">0 bloques</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item" id="agentStatus">
                    <span class="status-dot disconnected" id="agentStatusDot"></span>
                    <span id="agentStatusText">Agent: Verificando...</span>
                </div>
                <div class="status-item">MAX-IDE v1.0</div>
            </div>
        </footer>
    </div>
    
    <!-- Modal Monitor Serial -->
    <div class="modal-overlay" id="serialModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><span class="icon">üìü</span> Monitor Serial</h2>
                <button class="modal-close" id="btnCloseSerial">&times;</button>
            </div>
            <div class="modal-body">
                <div class="serial-controls">
                    <div class="control-group">
                        <label>Baudrate</label>
                        <select id="serialBaudrate">
                            <option value="9600">9600</option>
                            <option value="115200">115200</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="btnSerialConnect"><span>üîó</span> Conectar</button>
                    <button class="btn btn-danger hidden" id="btnSerialDisconnect"><span>‚õî</span> Desconectar</button>
                </div>
                <div class="serial-output" id="serialOutput">
                    <div class="line system">Esperando conexi√≥n...</div>
                </div>
                <div class="serial-input-container">
                    <input type="text" class="serial-input" id="serialInput" placeholder="Escribe un mensaje..." disabled>
                    <button class="btn btn-primary" id="btnSerialSend" disabled>Enviar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Modal de entrega -->
    <div class="submit-modal-overlay" id="submitModalOverlay">
        <div class="submit-modal">
            <h3>üì§ Confirmar Entrega</h3>
            <p>
                ¬øEst√°s seguro de que quieres entregar esta actividad?
                {% if not activity.allow_resubmit %}
                <br><strong>‚ö†Ô∏è Nota:</strong> No se permite re-entrega.
                {% endif %}
            </p>
            <div class="submit-status-message" id="submitStatusMessage"></div>
            <div class="submit-modal-actions">
                <button class="btn" id="btnCancelSubmit">Cancelar</button>
                <button class="btn btn-success" id="btnConfirmSubmit">Entregar</button>
            </div>
        </div>
    </div>
    
    <!-- Toolbox XML para Blockly -->
    <xml id="toolbox" style="display: none;">
        <category name="‚öôÔ∏è Estructura" colour="60">
            <block type="arduino_setup"></block>
            <block type="arduino_loop"></block>
        </category>
        
        <category name="üìå Digital" colour="230">
            <block type="arduino_pin_mode">
                <field name="PIN">13</field>
                <field name="MODE">OUTPUT</field>
            </block>
            <block type="arduino_digital_write">
                <field name="PIN">13</field>
                <field name="VALUE">HIGH</field>
            </block>
            <block type="arduino_digital_read">
                <field name="PIN">2</field>
            </block>
        </category>
        
        <category name="üìä Anal√≥gico" colour="180">
            <block type="arduino_analog_read">
                <field name="PIN">0</field>
            </block>
            <block type="arduino_analog_write">
                <field name="PIN">9</field>
                <value name="VALUE">
                    <block type="arduino_number">
                        <field name="NUM">128</field>
                    </block>
                </value>
            </block>
        </category>
        
        <category name="‚è±Ô∏è Tiempo" colour="330">
            <block type="arduino_delay">
                <value name="TIME">
                    <block type="arduino_number">
                        <field name="NUM">1000</field>
                    </block>
                </value>
            </block>
            <block type="arduino_delay_microseconds">
                <value name="TIME">
                    <block type="arduino_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="arduino_millis"></block>
            <block type="arduino_micros"></block>
        </category>
        
        <category name="üì° Serial" colour="20">
            <block type="arduino_serial_begin">
                <field name="BAUD">9600</field>
            </block>
            <block type="arduino_serial_print"></block>
            <block type="arduino_serial_println"></block>
            <block type="arduino_serial_available"></block>
            <block type="arduino_serial_read"></block>
        </category>
        
        <category name="üîÄ Control" colour="210">
            <label text="‚îÄ‚îÄ Condicionales ‚îÄ‚îÄ"></label>
            <block type="arduino_if"></block>
            <block type="arduino_if_else"></block>
            <block type="arduino_if_elseif"></block>
            <block type="arduino_if_elseif_else"></block>
            <block type="arduino_if_elseif2_else"></block>
            <label text="‚îÄ‚îÄ Ciclos ‚îÄ‚îÄ"></label>
            <block type="arduino_for">
                <field name="VAR">i</field>
                <field name="FROM">0</field>
                <field name="TO">10</field>
            </block>
            <block type="arduino_while"></block>
        </category>
        
        <category name="‚öñÔ∏è L√≥gica" colour="210">
            <block type="arduino_compare"></block>
            <block type="arduino_and"></block>
            <block type="arduino_or"></block>
            <block type="arduino_logic"></block>
            <block type="arduino_not"></block>
            <block type="arduino_true"></block>
            <block type="arduino_false"></block>
        </category>
        
        <category name="üî¢ Matem√°ticas" colour="200">
            <block type="arduino_number">
                <field name="NUM">0</field>
            </block>
            <block type="arduino_math"></block>
            <block type="arduino_map"></block>
            <block type="arduino_constrain"></block>
            <block type="arduino_random"></block>
        </category>
        
        <category name="üìù Variables" colour="290">
            <block type="arduino_variable_int"></block>
            <block type="arduino_variable_float"></block>
            <block type="arduino_variable_string"></block>
            <block type="arduino_variable_boolean"></block>
            <block type="arduino_get_variable"></block>
            <block type="arduino_set_variable"></block>
        </category>
        
        <category name="üìù Texto" colour="160">
            <block type="arduino_string">
                <field name="TEXT">Hola</field>
            </block>
        </category>
        
        <category name="üîß Componentes" colour="40">
            <block type="arduino_led_builtin">
                <field name="STATE">HIGH</field>
            </block>
            <block type="arduino_tone"></block>
            <block type="arduino_no_tone"></block>
        </category>
        
        <category name="ü¶æ Servos" colour="270">
            <block type="arduino_servo_attach">
                <field name="NAME">miServo</field>
                <field name="PIN">9</field>
            </block>
            <block type="arduino_servo_attach_limits">
                <field name="NAME">miServo</field>
                <field name="PIN">9</field>
                <field name="MIN">544</field>
                <field name="MAX">2400</field>
            </block>
            <block type="arduino_servo_write">
                <field name="NAME">miServo</field>
                <value name="ANGLE">
                    <block type="arduino_number">
                        <field name="NUM">90</field>
                    </block>
                </value>
            </block>
            <block type="arduino_servo_write_simple">
                <field name="NAME">miServo</field>
                <field name="ANGLE">90</field>
            </block>
            <block type="arduino_servo_write_microseconds">
                <field name="NAME">miServo</field>
                <value name="US">
                    <block type="arduino_number">
                        <field name="NUM">1500</field>
                    </block>
                </value>
            </block>
            <block type="arduino_servo_read">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_attached">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_detach">
                <field name="NAME">miServo</field>
            </block>
            <block type="arduino_servo_sweep">
                <field name="NAME">miServo</field>
                <field name="FROM">0</field>
                <field name="TO">180</field>
                <value name="DELAY">
                    <block type="arduino_number">
                        <field name="NUM">15</field>
                    </block>
                </value>
            </block>
        </category>
        
        <!-- üöó CARRITO MAX - Bloques especiales -->
        <category name="üöó Carrito MAX" colour="190" expanded="false">
            <category name="‚öôÔ∏è Inicializaci√≥n" colour="190">
                <block type="max_init_motores">
                    <field name="PIN_IZQ">9</field>
                    <field name="PIN_DER">10</field>
                </block>
                <block type="max_init_distancia">
                    <field name="PIN_TRIG">6</field>
                    <field name="PIN_ECHO">7</field>
                </block>
                <block type="max_init_lineas">
                    <field name="PIN_IZQ">0</field>
                    <field name="PIN_CENT">1</field>
                    <field name="PIN_DER">2</field>
                </block>
                <block type="max_init_buzzer">
                    <field name="PIN">3</field>
                </block>
                <block type="max_init_garra">
                    <field name="PIN">11</field>
                    <field name="CERRADA">140</field>
                    <field name="ABIERTA">40</field>
                </block>
            </category>
            
            <category name="üèéÔ∏è Movimiento" colour="120">
                <block type="max_adelante">
                    <field name="VEL">30</field>
                </block>
                <block type="max_atras">
                    <field name="VEL">30</field>
                </block>
                <block type="max_izquierda">
                    <field name="VEL">25</field>
                </block>
                <block type="max_derecha">
                    <field name="VEL">25</field>
                </block>
                <block type="max_detener"></block>
                <block type="max_adelante_var"></block>
                <block type="max_atras_var"></block>
                <block type="max_izquierda_var"></block>
                <block type="max_derecha_var"></block>
                <block type="max_avanzar_tiempo">
                    <field name="VEL">30</field>
                    <field name="TIEMPO">1000</field>
                </block>
                <block type="max_retroceder_tiempo">
                    <field name="VEL">30</field>
                    <field name="TIEMPO">1000</field>
                </block>
                <block type="max_girar_tiempo">
                    <field name="DIR">derecha</field>
                    <field name="VEL">25</field>
                    <field name="TIEMPO">500</field>
                </block>
            </category>
            
            <category name="üì° Sensor Distancia" colour="230">
                <block type="max_medir_distancia"></block>
                <block type="max_distancia_menor_que">
                    <field name="CM">20</field>
                </block>
                <block type="max_distancia_mayor_que">
                    <field name="CM">30</field>
                </block>
                <block type="max_evitar_obstaculo">
                    <field name="DISTANCIA">20</field>
                </block>
            </category>
            
            <category name="‚ûñ Sensor L√≠neas" colour="60">
                <block type="max_leer_linea_izq"></block>
                <block type="max_leer_linea_centro"></block>
                <block type="max_leer_linea_der"></block>
                <block type="max_linea_detectada">
                    <field name="SENSOR">CENT</field>
                    <field name="UMBRAL">500</field>
                </block>
                <block type="max_linea_comparar">
                    <field name="SENSOR">CENT</field>
                    <field name="OP"><</field>
                    <field name="UMBRAL">500</field>
                </block>
                <block type="max_linea_valor_comparar">
                    <field name="SENSOR">CENT</field>
                    <field name="OP"><</field>
                </block>
            </category>
            
            <category name="üéµ Buzzer/Sonido" colour="300">
                <block type="max_tocar_nota">
                    <field name="NOTA">262</field>
                    <field name="DURACION">300</field>
                </block>
                <block type="max_tocar_frecuencia">
                    <value name="FREQ">
                        <block type="arduino_number">
                            <field name="NUM">440</field>
                        </block>
                    </value>
                    <value name="DURACION">
                        <block type="arduino_number">
                            <field name="NUM">300</field>
                        </block>
                    </value>
                </block>
                <block type="max_beep"></block>
                <block type="max_detener_sonido"></block>
            </category>
            
            <category name="ü¶æ Garra" colour="45">
                <block type="max_abrir_garra"></block>
                <block type="max_cerrar_garra"></block>
                <block type="max_mover_garra">
                    <field name="ANGULO">45</field>
                </block>
            </category>
        </category>
        
        <category name="‚ö° Avanzado" colour="0">
            <block type="arduino_include">
                <field name="LIBRARY">Servo.h</field>
            </block>
            <block type="arduino_custom_code"></block>
            <block type="arduino_comment"></block>
        </category>
    </xml>
    
    <!-- Configuraci√≥n del IDE -->
    <script>
        const IDE_CONFIG = {
            projectId: '{{ project.id|default:"" }}',
            activityId: '{{ activity.id }}',
            institutionSlug: '{{ institution.slug }}',
            courseId: '{{ activity.course.id }}',
            isReadOnly: {{ is_read_only|yesno:"true,false" }},
            isFrozen: {{ is_frozen|yesno:"true,false" }},
            canSubmit: {{ can_submit|yesno:"true,false" }},
            allowResubmit: {{ activity.allow_resubmit|yesno:"true,false" }},
            autosaveEnabled: !{{ is_read_only|yesno:"true,false" }},
            autosaveInterval: 30000,
            submitUrl: '{% url "editor:student_activity_submit" institution_slug=institution.slug activity_id=activity.id %}',
            csrfToken: '{{ csrf_token }}'
        };
        
        // XML del proyecto si existe
        const blocklyXml = `{{ project.blockly_xml|default:""|escapejs }}`;
    </script>
    
    <!-- Scripts del IDE -->
    <script src="{% static 'editor/js/arduino_blocks.js' %}"></script>
    <script src="{% static 'editor/js/arduino_generator.js' %}"></script>
    <script src="{% static 'editor/js/app.js' %}"></script>
    
    <script>
        // Cargar XML del proyecto si existe
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (blocklyXml && blocklyXml.trim() && typeof Blockly !== 'undefined' && window.workspace) {
                    try {
                        const xml = Blockly.utils.xml.textToDom(blocklyXml);
                        Blockly.Xml.domToWorkspace(xml, window.workspace);
                        console.log('[Activity IDE] Proyecto cargado');
                    } catch (e) {
                        console.error('[Activity IDE] Error cargando proyecto:', e);
                    }
                }
            }, 1000);
        });
        
        // Sistema de entrega
        {% if can_submit and not is_frozen %}
        document.getElementById('btnSubmitActivity')?.addEventListener('click', function() {
            document.getElementById('submitModalOverlay').classList.add('active');
        });
        
        document.getElementById('btnCancelSubmit')?.addEventListener('click', function() {
            document.getElementById('submitModalOverlay').classList.remove('active');
        });
        
        document.getElementById('btnConfirmSubmit')?.addEventListener('click', async function() {
            const btn = this;
            const statusMsg = document.getElementById('submitStatusMessage');
            
            btn.disabled = true;
            btn.textContent = 'Entregando...';
            
            try {
                const formData = new FormData();
                formData.append('project_id', IDE_CONFIG.projectId);
                
                const response = await fetch(IDE_CONFIG.submitUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': IDE_CONFIG.csrfToken },
                    body: formData
                });
                
                statusMsg.className = 'submit-status-message show success';
                statusMsg.textContent = '‚úì ¬°Actividad entregada!';
                btn.textContent = '‚úì Entregado';
                
                setTimeout(() => window.location.reload(), 1500);
            } catch (e) {
                statusMsg.className = 'submit-status-message show error';
                statusMsg.textContent = '‚úó Error: ' + e.message;
                btn.disabled = false;
                btn.textContent = 'Reintentar';
            }
        });
        
        document.getElementById('submitModalOverlay')?.addEventListener('click', function(e) {
            if (e.target === this) this.classList.remove('active');
        });
        {% endif %}
    </script>
</body>
</html>
