{% extends 'editor/base.html' %}
{% load static %}

{% block title %}{{ activity.title }} - MAX-IDE{% endblock %}

{% block extra_head %}
<style>
    .activity-context {
        background: var(--color-bg-card, #161b22);
        border-bottom: 1px solid var(--color-border, #30363d);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .activity-context-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .activity-context-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--color-text-muted, #8b949e);
    }
    
    .activity-context-breadcrumb a {
        color: var(--color-primary, #58a6ff);
        text-decoration: none;
    }
    
    .activity-context-breadcrumb a:hover {
        text-decoration: underline;
    }
    
    .activity-context-title {
        font-weight: 600;
        color: var(--color-text, #e6edf3);
    }
    
    .activity-context-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .activity-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .badge-pending {
        background: var(--color-warning-glow, rgba(210, 153, 34, 0.15));
        color: var(--color-warning, #d29922);
    }
    
    .badge-inprogress {
        background: rgba(234, 179, 8, 0.15);
        color: #eab308;
    }
    
    .badge-submitted {
        background: var(--color-primary-glow, rgba(88, 166, 255, 0.15));
        color: var(--color-primary, #58a6ff);
    }
    
    .badge-graded {
        background: var(--color-success-glow, rgba(63, 185, 80, 0.15));
        color: var(--color-success, #3fb950);
    }
    
    .badge-readonly {
        background: var(--color-danger-glow, rgba(248, 81, 73, 0.15));
        color: var(--color-danger, #f85149);
    }
    
    /* Modal de confirmaci√≥n de entrega */
    .submit-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    
    .submit-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .submit-modal {
        background: var(--color-bg-secondary, #161b22);
        border: 1px solid var(--color-border, #30363d);
        border-radius: 12px;
        width: 90%;
        max-width: 450px;
        padding: 24px;
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    
    .submit-modal-overlay.active .submit-modal {
        transform: scale(1);
    }
    
    .submit-modal h3 {
        margin: 0 0 16px 0;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .submit-modal p {
        color: var(--color-text-muted, #8b949e);
        margin: 0 0 20px 0;
        line-height: 1.5;
    }
    
    .submit-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    
    .submit-modal .btn-cancel {
        background: transparent;
        border: 1px solid var(--color-border, #30363d);
        color: var(--color-text-muted, #8b949e);
    }
    
    .submit-modal .btn-confirm {
        background: var(--color-success, #238636);
        color: white;
    }
    
    .submit-status-message {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        display: none;
    }
    
    .submit-status-message.show {
        display: block;
    }
    
    .submit-status-message.success {
        background: rgba(46, 160, 67, 0.15);
        color: #3fb950;
    }
    
    .submit-status-message.error {
        background: rgba(248, 81, 73, 0.15);
        color: #f85149;
    }
    
    .alert-readonly {
        background: var(--color-danger-glow, rgba(248, 81, 73, 0.15));
        border: 1px solid var(--color-danger, #f85149);
        color: var(--color-danger, #f85149);
        padding: 12px 16px;
        border-radius: 6px;
        margin: 12px 20px;
    }
</style>
{% endblock %}

{% block body %}
<div class="app-container" data-institution-slug="{{ institution.slug }}">
    <!-- Agent Status Banner -->
    {% include 'partials/agent_status.html' %}
    
    <!-- Activity Context Bar -->
    <div class="activity-context">
        <div class="activity-context-left">
            <div class="activity-context-breadcrumb">
                <a href="{% url 'student_dashboard' slug=institution.slug %}">{{ institution.name }}</a>
                <span>/</span>
                <a href="{% url 'editor:student_courses_list' institution_slug=institution.slug %}">Cursos</a>
                <span>/</span>
                <a href="{% url 'editor:student_activities_list' institution_slug=institution.slug course_id=activity.course.id %}">{{ activity.course.name }}</a>
                <span>/</span>
                <span class="activity-context-title">{{ activity.title }}</span>
            </div>
        </div>
        <div class="activity-context-right">
            <!-- Badge de estado pedag√≥gico -->
            <span class="activity-badge" id="submissionStatusBadge">
            {% if last_submission %}
                {% if last_submission.status == 'graded' %}
                <span class="badge-graded">üü¢ Calificada</span>
                {% elif last_submission.status == 'submitted' %}
                <span class="badge-submitted">üîµ Entregada</span>
                {% else %}
                <span class="badge-inprogress">üü° En progreso</span>
                {% endif %}
            {% else %}
                <span class="badge-inprogress">üü° En progreso</span>
            {% endif %}
            </span>
            
            {% if is_frozen or is_read_only %}
            <span class="activity-badge badge-readonly">üîí Solo Lectura</span>
            {% endif %}
            
            {% if can_submit and not is_frozen %}
            <button class="btn btn-success btn-sm" id="btnSubmitActivity">
                üì§ Entregar
            </button>
            {% endif %}
        </div>
    </div>
    
    {% if is_frozen or is_read_only %}
    <div class="alert-readonly">
        <strong>‚ö†Ô∏è Modo Solo Lectura:</strong>
        {% if is_frozen %}
        Este workspace est√° congelado porque ya entregaste esta actividad y no se permite re-entrega.
        {% elif activity.is_closed %}
        Esta actividad est√° cerrada.
        {% elif activity.is_deadline_passed %}
        La fecha l√≠mite ya pas√≥.
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">‚ö°</div>
            <div class="logo-text">MAX-IDE</div>
            <span class="logo-badge">ARDUINO</span>
        </div>
        
        <div class="header-controls">
            <!-- Board Selector -->
            <div class="control-group">
                <label>
                    <span>üéØ</span>
                    Board
                </label>
                <select id="boardSelect">
                    <option value="arduino:avr:uno">Arduino UNO</option>
                    <option value="arduino:avr:nano">Arduino Nano</option>
                    <option value="arduino:avr:nano:cpu=atmega328old">Arduino Nano (Old Bootloader)</option>
                    <option value="arduino:avr:mega">Arduino Mega</option>
                    <option value="arduino:avr:leonardo">Arduino Leonardo</option>
                </select>
            </div>
            
            <!-- Port Selector -->
            <div class="control-group">
                <label>
                    <span>üîå</span>
                    Puerto
                </label>
                <select id="portSelect">
                    <option value="">Seleccionar...</option>
                </select>
                <button class="btn btn-icon-only btn-ghost" id="btnAddPort" title="Agregar nuevo puerto">
                    ‚ûï
                </button>
                <button class="btn btn-icon-only btn-ghost" id="btnRefreshPorts" title="Actualizar puertos">
                    üîÑ
                </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-ghost" id="btnSerialMonitor" title="Monitor Serial">
                    <span>üìü</span>
                    <span>Serial</span>
                </button>
                <button class="btn btn-warning" id="btnCompile" data-action="verify" {% if is_read_only %}disabled{% endif %}>
                    <span>‚öôÔ∏è</span>
                    <span>Verificar</span>
                </button>
                <button class="btn btn-success" id="btnUpload" data-action="upload" {% if is_read_only %}disabled{% endif %}>
                    <span>üöÄ</span>
                    <span>Subir</span>
                </button>
                <button class="btn btn-ghost" id="btnCopyDiagnostic" title="Copiar Diagn√≥stico">
                    <span>üìã</span>
                    <span>Copiar Diagn√≥stico</span>
                </button>
                <button class="btn btn-ghost" id="btnReportError" title="Reportar Error">
                    <span>‚ö†Ô∏è</span>
                    <span>Reportar</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Workspace de Blockly -->
        <div class="workspace-container">
            <div class="workspace-header">
                <div class="workspace-tabs">
                    <button class="workspace-tab active">
                        <span>üì¶</span>
                        Bloques
                    </button>
                </div>
                <div class="workspace-actions">
                    {% if not is_read_only %}
                    <button class="btn btn-sm btn-ghost" id="btnAutoSave" title="Auto-guardado activo">
                        üíæ Auto-guardado
                    </button>
                    <button class="btn btn-sm btn-ghost" id="btnCreateSnapshot" title="Crear Snapshot">
                        üì∏ Snapshot
                    </button>
                    {% endif %}
                </div>
            </div>
            <div id="blocklyDiv" class="blockly-workspace"></div>
        </div>
        
        <!-- Code Editor -->
        <div class="code-container">
            <div class="code-header">
                <div class="code-tabs">
                    <button class="code-tab active" data-tab="arduino">
                        <span>üìù</span>
                        Arduino
                    </button>
                </div>
                <div class="code-actions">
                    <button class="btn btn-sm btn-ghost" id="btnCopyCode" title="Copiar c√≥digo">
                        üìã Copiar
                    </button>
                </div>
            </div>
            <pre id="arduinoCode" class="code-content" {% if is_read_only %}readonly{% endif %}></pre>
        </div>
    </main>
</div>

<!-- Toolbox XML -->
<xml id="toolbox" style="display: none;">
    <!-- El toolbox se carga desde el template base o desde un archivo separado -->
</xml>

<!-- Modal de confirmaci√≥n de entrega -->
<div class="submit-modal-overlay" id="submitModalOverlay">
    <div class="submit-modal">
        <h3>üì§ Confirmar Entrega</h3>
        <p>
            ¬øEst√°s seguro de que quieres entregar esta actividad?
            {% if not activity.allow_resubmit %}
            <br><strong>‚ö†Ô∏è Nota:</strong> Esta actividad no permite re-entregas. Una vez entregada, no podr√°s editarla.
            {% else %}
            <br>Podr√°s volver a entregar si lo necesitas.
            {% endif %}
        </p>
        <div class="submit-status-message" id="submitStatusMessage"></div>
        <div class="submit-modal-actions">
            <button class="btn btn-cancel" id="btnCancelSubmit">Cancelar</button>
            <button class="btn btn-confirm" id="btnConfirmSubmit">
                <span id="btnConfirmSubmitText">Entregar</span>
            </button>
        </div>
    </div>
</div>

<script>
    // Configuraci√≥n del IDE con contexto de actividad
    const IDE_CONFIG = {
        projectId: '{{ project.id }}',
        activityId: '{{ activity.id }}',
        institutionSlug: '{{ institution.slug }}',
        courseId: '{{ activity.course.id }}',
        isReadOnly: {{ is_read_only|yesno:"true,false" }},
        isFrozen: {{ is_frozen|yesno:"true,false" }},
        canSubmit: {{ can_submit|yesno:"true,false" }},
        allowResubmit: {{ activity.allow_resubmit|yesno:"true,false" }},
        autosaveEnabled: !{{ is_read_only|yesno:"true,false" }},
        autosaveInterval: 30000, // 30 segundos
        submitUrl: '{% url "editor:student_activity_submit" institution_slug=institution.slug activity_id=activity.id %}',
        csrfToken: '{{ csrf_token }}'
    };
    
    // Inicializar Blockly con el proyecto
    const blocklyXml = {{ project.blockly_xml|default:"''"|safe }};
    
    // Funciones del modal de entrega
    function openSubmitModal() {
        document.getElementById('submitModalOverlay').classList.add('active');
        document.getElementById('submitStatusMessage').className = 'submit-status-message';
        document.getElementById('submitStatusMessage').textContent = '';
        document.getElementById('btnConfirmSubmit').disabled = false;
        document.getElementById('btnConfirmSubmitText').textContent = 'Entregar';
    }
    
    function closeSubmitModal() {
        document.getElementById('submitModalOverlay').classList.remove('active');
    }
    
    async function performSubmit() {
        const btn = document.getElementById('btnConfirmSubmit');
        const btnText = document.getElementById('btnConfirmSubmitText');
        const statusMsg = document.getElementById('submitStatusMessage');
        
        btn.disabled = true;
        btnText.innerHTML = '<span class="mini-spinner"></span> Entregando...';
        statusMsg.className = 'submit-status-message';
        
        try {
            // Crear FormData con el project_id
            const formData = new FormData();
            formData.append('project_id', IDE_CONFIG.projectId);
            
            const response = await fetch(IDE_CONFIG.submitUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': IDE_CONFIG.csrfToken
                },
                body: formData
            });
            
            if (response.redirected) {
                // √âxito - la vista redirige
                statusMsg.className = 'submit-status-message show success';
                statusMsg.textContent = '‚úì ¬°Actividad entregada exitosamente!';
                btnText.textContent = '‚úì Entregado';
                
                // Actualizar badge
                updateSubmissionBadge('submitted');
                
                // Esperar un momento y recargar
                setTimeout(() => {
                    window.location.href = response.url;
                }, 1500);
            } else if (!response.ok) {
                throw new Error('Error en la entrega');
            } else {
                // √âxito sin redirect
                statusMsg.className = 'submit-status-message show success';
                statusMsg.textContent = '‚úì ¬°Actividad entregada exitosamente!';
                btnText.textContent = '‚úì Entregado';
                updateSubmissionBadge('submitted');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        } catch (error) {
            statusMsg.className = 'submit-status-message show error';
            statusMsg.textContent = '‚úó Error al entregar: ' + (error.message || 'Intenta de nuevo');
            btn.disabled = false;
            btnText.textContent = 'Reintentar';
        }
    }
    
    function updateSubmissionBadge(status) {
        const badge = document.getElementById('submissionStatusBadge');
        if (badge) {
            if (status === 'submitted') {
                badge.innerHTML = '<span class="badge-submitted">üîµ Entregada</span>';
            } else if (status === 'graded') {
                badge.innerHTML = '<span class="badge-graded">üü¢ Calificada</span>';
            } else {
                badge.innerHTML = '<span class="badge-inprogress">üü° En progreso</span>';
            }
        }
        
        // Deshabilitar bot√≥n de entregar si ya entreg√≥
        if (status === 'submitted' || status === 'graded') {
            const submitBtn = document.getElementById('btnSubmitActivity');
            if (submitBtn && !IDE_CONFIG.allowResubmit) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
            }
        }
    }
    
    // Event listeners del modal
    {% if can_submit and not is_frozen %}
    document.getElementById('btnSubmitActivity')?.addEventListener('click', openSubmitModal);
    document.getElementById('btnCancelSubmit')?.addEventListener('click', closeSubmitModal);
    document.getElementById('btnConfirmSubmit')?.addEventListener('click', performSubmit);
    document.getElementById('submitModalOverlay')?.addEventListener('click', function(e) {
        if (e.target === this) closeSubmitModal();
    });
    {% endif %}
    
    // Deshabilitar botones de compilar/subir si Agent est√° offline
    if (typeof checkAgentStatus === 'function') {
        checkAgentStatus('{{ institution.slug }}').then(function(isOnline) {
            if (!isOnline) {
                document.getElementById('btnCompile')?.setAttribute('disabled', 'true');
                document.getElementById('btnUpload')?.setAttribute('disabled', 'true');
            }
        });
    }
</script>

<!-- Scripts del IDE -->
<script src="{% static 'editor/js/app.js' %}"></script>
<script src="{% static 'editor/js/arduino_blocks.js' %}"></script>
<script src="{% static 'editor/js/arduino_generator.js' %}"></script>
{% endblock %}
