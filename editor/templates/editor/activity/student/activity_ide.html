<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ activity.title }} - MAX-IDE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        :root {
            --color-bg: #0d1117;
            --color-bg-secondary: #161b22;
            --color-bg-tertiary: #21262d;
            --color-text: #c9d1d9;
            --color-text-muted: #8b949e;
            --color-border: #30363d;
            --color-primary: #58a6ff;
            --color-success: #2ea043;
            --color-warning: #e3b341;
            --color-danger: #f85149;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .ide-header {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .activity-info h1 {
            font-size: 18px;
            font-weight: 600;
        }
        .activity-info .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: rgba(46, 160, 67, 0.2); color: #2ea043; }
        .badge-warning { background: rgba(227, 179, 65, 0.2); color: #e3b341; }
        .badge-danger { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .badge-info { background: rgba(88, 166, 255, 0.2); color: #58a6ff; }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }
        .btn-primary:hover { background: #4393e6; }
        .btn-success {
            background: var(--color-success);
            color: white;
        }
        .btn-success:hover { background: #238636; }
        .btn-ghost {
            background: transparent;
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        .btn-ghost:hover { background: var(--color-bg-tertiary); }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Alert Banner */
        .alert-banner {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .alert-banner.readonly {
            background: rgba(227, 179, 65, 0.15);
            border-bottom: 1px solid rgba(227, 179, 65, 0.3);
            color: #e3b341;
        }
        .alert-banner.deadline {
            background: rgba(248, 81, 73, 0.15);
            border-bottom: 1px solid rgba(248, 81, 73, 0.3);
            color: #f85149;
        }
        
        /* Main Content */
        .ide-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .blockly-container {
            flex: 1;
            position: relative;
        }
        #blocklyDiv {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .code-panel {
            width: 400px;
            background: var(--color-bg-secondary);
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
        }
        .code-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            font-weight: 600;
            font-size: 14px;
        }
        .code-panel-content {
            flex: 1;
            overflow: auto;
        }
        #arduinoCode {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: var(--color-text);
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            padding: 16px;
            resize: none;
        }
        #arduinoCode:focus { outline: none; }
        
        /* Submit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--color-bg-secondary);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 480px;
            border: 1px solid var(--color-border);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            font-size: 18px;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 20px;
            cursor: pointer;
        }
        .modal-body p {
            color: var(--color-text-muted);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: var(--color-bg-tertiary);
            color: var(--color-text);
            font-size: 14px;
            resize: vertical;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        /* Status bar */
        .status-bar {
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--color-text-muted);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="ide-header">
        <div class="activity-info">
            <a href="{% url 'editor:student_group_activities' institution_slug=institution.slug %}" class="btn btn-ghost" style="padding: 6px 10px;">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>{{ activity.title }}</h1>
            {% if submission %}
            <span class="badge {% if submission.status == 'submitted' %}badge-info{% elif submission.status == 'graded' %}badge-success{% else %}badge-warning{% endif %}">
                {{ submission.get_status_display }}
            </span>
            {% endif %}
            {% if submission.is_late %}
            <span class="badge badge-warning">TardÃ­a</span>
            {% endif %}
        </div>
        
        <div class="header-actions">
            <button id="btnSave" class="btn btn-ghost" {% if is_read_only %}disabled{% endif %}>
                <i class="fas fa-save"></i> Guardar
            </button>
            
            {% if can_submit %}
            <button id="btnSubmit" class="btn btn-success">
                <i class="fas fa-paper-plane"></i> Entregar
            </button>
            {% else %}
            <button class="btn btn-ghost" disabled title="{{ submit_reason }}">
                <i class="fas fa-lock"></i> {{ submit_reason|truncatewords:3 }}
            </button>
            {% endif %}
        </div>
    </header>
    
    <!-- Alert Banner -->
    {% if is_read_only %}
    <div class="alert-banner readonly">
        <i class="fas fa-lock"></i>
        <span>Modo solo lectura - Ya entregaste esta actividad</span>
    </div>
    {% elif activity.is_deadline_passed %}
    <div class="alert-banner deadline">
        <i class="fas fa-clock"></i>
        <span>La fecha lÃ­mite ha pasado{% if activity.allow_late_submit %} (entrega tardÃ­a permitida){% endif %}</span>
    </div>
    {% endif %}
    
    <!-- Main Content -->
    <main class="ide-main">
        <div class="blockly-container">
            <div id="blocklyDiv"></div>
        </div>
        
        <div class="code-panel">
            <div class="code-panel-header">
                <i class="fas fa-code"></i> CÃ³digo Arduino
            </div>
            <div class="code-panel-content">
                <textarea id="arduinoCode" readonly placeholder="El cÃ³digo se generarÃ¡ aquÃ­..."></textarea>
            </div>
        </div>
    </main>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <span id="saveStatus">Listo</span>
        <span>{{ activity.title }} | MÃ¡x: {{ activity.max_score }} pts</span>
    </div>
    
    <!-- Submit Modal -->
    <div id="submitModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-paper-plane"></i> Entregar Actividad</h2>
                <button class="modal-close" onclick="closeSubmitModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡s seguro de que deseas entregar esta actividad?
                {% if not activity.allow_resubmit %}
                <br><strong>Nota:</strong> No se permite re-entrega.
                {% endif %}
                </p>
                
                <div class="form-group">
                    <label for="submitNotes">Notas (opcional)</label>
                    <textarea id="submitNotes" rows="3" placeholder="Escribe un comentario para tu tutor..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeSubmitModal()">Cancelar</button>
                <button id="btnConfirmSubmit" class="btn btn-success">
                    <i class="fas fa-check"></i> Confirmar Entrega
                </button>
            </div>
        </div>
    </div>
    
    <!-- Blockly Toolbox - Arduino/MAX completo -->
    <xml id="toolbox" style="display: none">
        <category name="âš™ï¸ Estructura" colour="60">
            <block type="arduino_setup"></block>
            <block type="arduino_loop"></block>
        </category>
        
        <category name="ðŸ”€ Control" colour="210">
            <block type="arduino_if"></block>
            <block type="arduino_if_else"></block>
            <block type="arduino_if_elseif"></block>
            <block type="arduino_if_elseif_else"></block>
            <block type="arduino_for">
                <field name="VAR">i</field>
                <field name="FROM">0</field>
                <field name="TO">10</field>
            </block>
            <block type="arduino_while"></block>
        </category>
        
        <category name="âš–ï¸ LÃ³gica" colour="210">
            <block type="arduino_compare"></block>
            <block type="arduino_and"></block>
            <block type="arduino_or"></block>
            <block type="arduino_logic"></block>
            <block type="arduino_not"></block>
            <block type="arduino_true"></block>
            <block type="arduino_false"></block>
        </category>
        
        <category name="ðŸ”¢ MatemÃ¡ticas" colour="200">
            <block type="arduino_number">
                <field name="NUM">0</field>
            </block>
            <block type="arduino_math"></block>
            <block type="arduino_map"></block>
            <block type="arduino_constrain"></block>
            <block type="arduino_random"></block>
        </category>
        
        <category name="ðŸ“ Texto" colour="160">
            <block type="arduino_string">
                <field name="TEXT">Hola</field>
            </block>
        </category>
        
        <category name="ðŸ“Š Variables" colour="290">
            <block type="arduino_variable_int"></block>
            <block type="arduino_variable_float"></block>
            <block type="arduino_variable_boolean"></block>
            <block type="arduino_get_variable"></block>
            <block type="arduino_set_variable"></block>
        </category>
        
        <category name="â±ï¸ Tiempo" colour="330">
            <block type="arduino_delay"></block>
            <block type="arduino_delay_microseconds"></block>
            <block type="arduino_millis"></block>
        </category>
        
        <category name="ðŸ“¡ Serial" colour="20">
            <block type="arduino_serial_begin"></block>
            <block type="arduino_serial_print"></block>
            <block type="arduino_serial_println"></block>
        </category>

        <sep></sep>
        
        <!-- CARRITO MAX -->
        <category name="ðŸš— MAX Robot" colour="190" expanded="true">
            <category name="ðŸ”§ InicializaciÃ³n" colour="190">
                <block type="max_init_motores">
                    <field name="PIN_IZQ">9</field>
                    <field name="PIN_DER">10</field>
                </block>
                <block type="max_init_distancia">
                    <field name="PIN_TRIG">6</field>
                    <field name="PIN_ECHO">7</field>
                </block>
                <block type="max_init_lineas">
                    <field name="PIN_IZQ">0</field>
                    <field name="PIN_CENT">1</field>
                    <field name="PIN_DER">2</field>
                </block>
                <block type="max_init_buzzer">
                    <field name="PIN">3</field>
                </block>
                <block type="max_init_garra">
                    <field name="PIN">11</field>
                </block>
            </category>
            
            <category name="ðŸš— Movimiento" colour="120">
                <block type="max_adelante">
                    <field name="VEL">30</field>
                </block>
                <block type="max_atras">
                    <field name="VEL">30</field>
                </block>
                <block type="max_izquierda">
                    <field name="VEL">25</field>
                </block>
                <block type="max_derecha">
                    <field name="VEL">25</field>
                </block>
                <block type="max_detener"></block>
                <block type="max_avanzar_tiempo">
                    <field name="VEL">30</field>
                    <field name="TIEMPO">1000</field>
                </block>
                <block type="max_girar_tiempo">
                    <field name="DIR">derecha</field>
                    <field name="VEL">25</field>
                    <field name="TIEMPO">500</field>
                </block>
            </category>
            
            <category name="ðŸ“¡ Sensor Distancia" colour="230">
                <block type="max_medir_distancia"></block>
                <block type="max_distancia_menor_que">
                    <field name="CM">20</field>
                </block>
                <block type="max_distancia_mayor_que">
                    <field name="CM">30</field>
                </block>
                <block type="max_evitar_obstaculo">
                    <field name="DISTANCIA">20</field>
                </block>
            </category>
            
            <category name="âž– Sensor LÃ­neas" colour="60">
                <block type="max_leer_linea_izq"></block>
                <block type="max_leer_linea_centro"></block>
                <block type="max_leer_linea_der"></block>
                <block type="max_linea_detectada">
                    <field name="SENSOR">CENT</field>
                    <field name="UMBRAL">500</field>
                </block>
                <block type="max_linea_comparar">
                    <field name="SENSOR">CENT</field>
                    <field name="OP"><</field>
                    <field name="UMBRAL">500</field>
                </block>
                <block type="max_linea_valor_comparar">
                    <field name="SENSOR">CENT</field>
                    <field name="OP"><</field>
                </block>
            </category>
            
            <category name="ðŸŽµ Buzzer/Sonido" colour="300">
                <block type="max_tocar_nota">
                    <field name="NOTA">262</field>
                    <field name="DURACION">300</field>
                </block>
                <block type="max_beep"></block>
                <block type="max_detener_sonido"></block>
            </category>
            
            <category name="ðŸ¦¾ Garra" colour="45">
                <block type="max_abrir_garra"></block>
                <block type="max_cerrar_garra"></block>
                <block type="max_mover_garra">
                    <field name="ANGULO">90</field>
                </block>
            </category>
        </category>
    </xml>
    
    <script src="{% static 'editor/js/arduino_blocks.js' %}?v={{ request.timestamp|default:'1' }}"></script>
    <script src="{% static 'editor/js/arduino_generator.js' %}?v={{ request.timestamp|default:'1' }}"></script>
    <script>
        // ConfiguraciÃ³n
        const activityId = "{{ activity.id }}";
        const institutionSlug = "{{ institution.slug }}";
        const isReadOnly = {{ is_read_only|yesno:"true,false" }};
        const canSubmit = {{ can_submit|yesno:"true,false" }};
        const csrfToken = "{{ csrf_token }}";
        
        // URLs de API
        const saveUrl = `/i/${institutionSlug}/api/activity/${activityId}/save/`;
        const submitUrl = `/i/${institutionSlug}/api/activity/${activityId}/submit/`;
        
        // Inicializar Blockly
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: { spacing: 20, length: 3, colour: '#30363d', snap: true },
            zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
            trashcan: true,
            readOnly: isReadOnly
        });
        
        // Cargar XML previo si existe
        const savedXml = `{{ project_xml|escapejs }}`;
        if (savedXml) {
            try {
                const xml = Blockly.utils.xml.textToDom(savedXml);
                Blockly.Xml.domToWorkspace(xml, workspace);
            } catch (e) {
                console.error('Error loading XML:', e);
            }
        }
        
        // Generar cÃ³digo cuando cambie el workspace
        function updateCode() {
            try {
                const code = Blockly.Arduino ? Blockly.Arduino.workspaceToCode(workspace) : '// Generador no disponible';
                document.getElementById('arduinoCode').value = code;
            } catch (e) {
                document.getElementById('arduinoCode').value = '// Error generando cÃ³digo';
            }
        }
        
        workspace.addChangeListener(updateCode);
        updateCode();
        
        // Guardar progreso
        let saveTimeout;
        async function saveProgress() {
            if (isReadOnly) return;
            
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            const arduinoCode = document.getElementById('arduinoCode').value;
            
            document.getElementById('saveStatus').textContent = 'Guardando...';
            
            try {
                const response = await fetch(saveUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        xml_content: xmlText,
                        arduino_code: arduinoCode
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    document.getElementById('saveStatus').textContent = 'Guardado âœ“';
                } else {
                    document.getElementById('saveStatus').textContent = 'Error al guardar';
                }
            } catch (e) {
                document.getElementById('saveStatus').textContent = 'Error de conexiÃ³n';
            }
        }
        
        // Autosave
        workspace.addChangeListener(() => {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveProgress, 3000);
        });
        
        // BotÃ³n guardar
        document.getElementById('btnSave').addEventListener('click', saveProgress);
        
        // Modal de entrega
        function openSubmitModal() {
            document.getElementById('submitModal').classList.add('active');
        }
        
        function closeSubmitModal() {
            document.getElementById('submitModal').classList.remove('active');
        }
        
        if (canSubmit) {
            document.getElementById('btnSubmit').addEventListener('click', openSubmitModal);
        }
        
        // Confirmar entrega
        document.getElementById('btnConfirmSubmit').addEventListener('click', async () => {
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            const arduinoCode = document.getElementById('arduinoCode').value;
            const notes = document.getElementById('submitNotes').value;
            
            const btn = document.getElementById('btnConfirmSubmit');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entregando...';
            
            try {
                const response = await fetch(submitUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        xml_content: xmlText,
                        arduino_code: arduinoCode,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert('Â¡Actividad entregada exitosamente!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Entrega';
                }
            } catch (e) {
                alert('Error de conexiÃ³n');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Entrega';
            }
        });
    </script>
</body>
</html>
